// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.19;

import {IERC20All} from "test/shared/interfaces/IERC20All.sol";
import {BaseTest} from "test/shared/BaseTest.sol";
import {Chains, Tokens, Lenders} from "test/data/LenderRegistry.sol";
import "contracts/utils/CalldataLib.sol";
import {console} from "forge-std/console.sol";
import {ComposerPlugin, IComposerLike} from "plugins/ComposerPlugin.sol";

import "../../../contracts/external-protocols/misc/FeeOnTransferDetector.sol";
import "./ECSDA.sol";

// solhint-disable max-line-length

interface IA {
    function upgradeAndCall(address proxy, address implementation, bytes memory data) external;
}

contract ForkTestMantle is BaseTest {
    IComposerLike oneDV2;

    address admin = 0x9ACC4fbBe3237e8f04173ECA2c5b19c277305f56;
    address owner = 0x999999833d965c275A2C102a4Ebf222ca938546f;
    address proxy = 0xCDef0A216fcEF809258aA4f341dB1A5aB296ea72;

    address mockSender = 0x91ae002a960e63Ccb0E5bDE83A8C13E51e1cB91A;
    // address mockSender = 0xdFF70A71618739f4b8C81B11254BcE855D02496B;

    uint256 internal constant forkBlock = 137711502;

    function setUp() public virtual {
        // initialize the chain
        string memory chainName = Chains.OP_MAINNET;

        _init(chainName, forkBlock, true);

        oneDV2 = ComposerPlugin.getComposer(chainName);

        vm.prank(owner);
        IA(admin).upgradeAndCall(proxy, address(oneDV2), hex"");

        labelAddresses();
    }

    function labelAddresses() internal {
        vm.label(owner, "owner");
        vm.label(admin, "admin");
        vm.label(proxy, "proxy");
        vm.label(address(oneDV2), "Composer");
        vm.label(mockSender, "MeMeMeMe");
    }

    function test_fork_raw_op_swap() external {
        vm.prank(mockSender);
        address(proxy).call{value: 0.000818662696083434e18}(getData());
    }

    function test_fork_params_op() external {
        vm.prank(mockSender);
        (bytes memory params, uint256 value) = getParams2();
        IComposerLike(proxy).deltaCompose{value: value}(params);
    }

    // nonce 0n
    // cometCreditPermit.ts:120 expiry 1748970849
    // cometCreditPermit.ts:121 v,r,s 27n 0x8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f 0x16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab
    // cometCreditPermit.ts:126 r 8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f
    // cometCreditPermit.ts:127 vs 16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab

    function getData() internal pure returns (bytes memory d) {
        d =
            hex"17d73091000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000007d720fca1154c643c32638aee9a43eee7f377f515c80100000000000000000002e891c330dfea06ab206131b5fae19ea4f9d964eac0408e4408b66337b500000000000000000002e891c330dfea0684e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000000e801010000003d02000000478946bcd4a5a22b316470f5486fafb928c0ba2500000000000000000002e891c330dfea0100000000000000000000000000000000000000000aeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0b2c639c533813f4aa9d7837caf62653d097ff85cdef0a216fcef809258aa4f341db1a5ab296ea72000000000000000000000000685e7d6000000054000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000001e99d54f82e73edb06d29ff62c91ec8f5ff06571bdeb29000000000000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000000b2c639c533813f4aa9d7837caf62653d097ff850000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000cdef0a216fcef809258aa4f341db1a5ab296ea720000000000000000000000000000000000000000000000000002e891c330dfea00000000000000000000000000000000000000000000000000000000001e8254000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002807b22536f75726365223a226e756c6c3a6c6f63616c686f7374222c22416d6f756e74496e555344223a22322e3030353935353438383234313837222c22416d6f756e744f7574555344223a22322e30303538383436393932383737343733222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2232303035343631222c2254696d657374616d70223a313735313032313734342c22526f7574654944223a2263656233653662362d323063322d346663652d393363302d3362383166306136663033653a35663562316637662d373865642d346462342d383937612d333339376432626133373434222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a22415256735877583064542b4b2b75376e6a38772b68672f336c62437836334b2b454f764e4c6e44397347576c594c7a446f556f4d387a347a326d41774b4a7365784c322f38627448465444636e72784c4549664a73356e54506b3252456576566756464d39466a4a396333594d55394b61356a44673077596d6e4f7747347a7948334843765a44735a4830387254304174753179636b4a44677a525379775876696e785a4877766379574a4336754a6d5a497762594b38726d682b4a346c50766d75323357377742437478702f64446b4b6c6c6a43784935465735686f5a796c4658426a7473493542454f456e4642616638526954717653466231386b535542785a484178462b6365744e69314f4b33666a306f6b4e4b5766457664534e5369544841575278744662526158394d55673268636c66647a636b68574b696d3169575237436d6741585357323752554b555942304456773d3d227d7d40010000000000000000000000000000000000000000cdef0a216fcef809258aa4f341db1a5ab296ea72000000000000000000000000000000000040050b2c639c533813f4aa9d7837caf62653d097ff85794a61358d6845594f94dc1db02a252b5b4814ad300203e70b2c639c533813f4aa9d7837caf62653d097ff85000000000000000000000000001e99d591ae002a960e63ccb0e5bde83a8c13e51e1cb91a025d557b07776d12967914379c71a1310e917c7555794a61358d6845594f94dc1db02a252b5b4814ad40010b2c639c533813f4aa9d7837caf62653d097ff8591ae002a960e63ccb0e5bde83a8c13e51e1cb91a0000000000000000000000000000000000000000000000000000";
    }

    function getParams2() internal pure returns (bytes memory d, uint256 value) {
        value = 0.000818662696083434e18;
        d =
            hex"20fca1154c643c32638aee9a43eee7f377f515c80100000000000000000002e891c330dfea06ab206131b5fae19ea4f9d964eac0408e4408b66337b500000000000000000002e891c330dfea0684e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000000e801010000003d02000000478946bcd4a5a22b316470f5486fafb928c0ba2500000000000000000002e891c330dfea0100000000000000000000000000000000000000000aeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0b2c639c533813f4aa9d7837caf62653d097ff85cdef0a216fcef809258aa4f341db1a5ab296ea72000000000000000000000000685e7d6000000054000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000001e99d54f82e73edb06d29ff62c91ec8f5ff06571bdeb29000000000000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000000b2c639c533813f4aa9d7837caf62653d097ff850000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000cdef0a216fcef809258aa4f341db1a5ab296ea720000000000000000000000000000000000000000000000000002e891c330dfea00000000000000000000000000000000000000000000000000000000001e8254000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002807b22536f75726365223a226e756c6c3a6c6f63616c686f7374222c22416d6f756e74496e555344223a22322e3030353935353438383234313837222c22416d6f756e744f7574555344223a22322e30303538383436393932383737343733222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2232303035343631222c2254696d657374616d70223a313735313032313734342c22526f7574654944223a2263656233653662362d323063322d346663652d393363302d3362383166306136663033653a35663562316637662d373865642d346462342d383937612d333339376432626133373434222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a22415256735877583064542b4b2b75376e6a38772b68672f336c62437836334b2b454f764e4c6e44397347576c594c7a446f556f4d387a347a326d41774b4a7365784c322f38627448465444636e72784c4549664a73356e54506b3252456576566756464d39466a4a396333594d55394b61356a44673077596d6e4f7747347a7948334843765a44735a4830387254304174753179636b4a44677a525379775876696e785a4877766379574a4336754a6d5a497762594b38726d682b4a346c50766d75323357377742437478702f64446b4b6c6c6a43784935465735686f5a796c4658426a7473493542454f456e4642616638526954717653466231386b535542785a484178462b6365744e69314f4b33666a306f6b4e4b5766457664534e5369544841575278744662526158394d55673268636c66647a636b68574b696d3169575237436d6741585357323752554b555942304456773d3d227d7d40010000000000000000000000000000000000000000cdef0a216fcef809258aa4f341db1a5ab296ea72000000000000000000000000000000000040050b2c639c533813f4aa9d7837caf62653d097ff85794a61358d6845594f94dc1db02a252b5b4814ad300203e70b2c639c533813f4aa9d7837caf62653d097ff850000000000000000000000000000000091ae002a960e63ccb0e5bde83a8c13e51e1cb91a025d557b07776d12967914379c71a1310e917c7555794a61358d6845594f94dc1db02a252b5b4814ad40010b2c639c533813f4aa9d7837caf62653d097ff8591ae002a960e63ccb0e5bde83a8c13e51e1cb91a0000000000000000000000000000000000";
    }
}
