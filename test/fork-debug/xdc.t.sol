// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.19;

import {IERC20All} from "test/shared/interfaces/IERC20All.sol";
import {BaseTest} from "test/shared/BaseTest.sol";
import {Chains, Tokens, Lenders} from "test/data/LenderRegistry.sol";
import "contracts/utils/CalldataLib.sol";
import {console} from "forge-std/console.sol";
import {ComposerPlugin, IComposerLike} from "plugins/ComposerPlugin.sol";

interface IA {
    function upgradeAndCall(address proxy, address implementation, bytes memory data) external;
}

contract ForkTestXdc is BaseTest {
    IComposerLike oneDV2;

    // arb
    // address admin = 0x492d53456Cc219A755Ac5a2d8598fFd6F47A9fD1;
    // address owner = 0x999999833d965c275A2C102a4Ebf222ca938546f;
    // address proxy = 0x05f3f58716a88A52493Be45aA0871c55b3748f18;

    // op
    address admin = 0x36908C085E96782E67D4AEbFF6900E77da415570;
    address owner = 0x999999833d965c275A2C102a4Ebf222ca938546f;
    address proxy = 0xcB6Eb8df68153cebF60E1872273Ef52075a5C297;

    address mockSender = 0x444444131DB4dd4A6752CF83321D4b203342FD2B;
    // address mockSender = 0xdFF70A71618739f4b8C81B11254BcE855D02496B;

    uint256 internal constant forkBlock = 0;

    function setUp() public virtual {
        // initialize the chain
        string memory chainName = Chains.XDC_NETWORK;

        _init(chainName, forkBlock, true);

        oneDV2 = ComposerPlugin.getComposer(chainName);

        vm.prank(owner);
        IA(admin).upgradeAndCall(proxy, address(oneDV2), hex"");

        labelAddresses();
    }

    function labelAddresses() internal {
        vm.label(owner, "owner");
        vm.label(admin, "admin");
        vm.label(proxy, "proxy");
        vm.label(address(oneDV2), "Composer");
        vm.label(mockSender, "MeMeMeMe");
    }

    function test_fork_raw_xdc() external {
        vm.prank(mockSender);
        address(proxy).call{value: 0.000e18}(getData());
    }

    function test_fork_params_xdc() external {
        vm.prank(mockSender);
        (bytes memory params, uint256 value) = getParams2();
        IComposerLike(proxy).deltaCompose{value: value}(params);
    }

    // nonce 0n
    // cometCreditPermit.ts:120 expiry 1748970849
    // cometCreditPermit.ts:121 v,r,s 27n 0x8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f 0x16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab
    // cometCreditPermit.ts:126 r 8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f
    // cometCreditPermit.ts:127 vs 16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab

    function getData() internal pure returns (bytes memory d) {
        d =
            hex"17d730910000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000053d1000000000000006168a6643f8c07800000000000000000000000000005358fbf3951857744785e80e2de051c32ee7b25f9c458c420000fa2958cb79b0491cc627c1557f441ef849ca8eb1cb6eb8df68153cebf60e1872273ef52075a5c2970029f804974da123e8e48acb107be76b9f2ce1b408000bb804131000000000000006168a6643f8c078000000000000000000000000000053580e62951857744785e80e2de051c32ee7b25f9c458c420000fa2958cb79b0491cc627c1557f441ef849ca8eb1cb6eb8df68153cebf60e1872273ef52075a5c297005854b550482dc2785c9c4ecdb235076b5e1d75b7000bb8039a4005fa2958cb79b0491cc627c1557f441ef849ca8eb170d8005e3c8c7e383fe35fa40156042f3393449f300003e7fa2958cb79b0491cc627c1557f441ef849ca8eb100000000000000000000000000000000444444131db4dd4a6752cf83321d4b203342fd2b70d8005e3c8c7e383fe35fa40156042f3393449f300103e749d3f7543335cf38fa10889ccff10207e22110b5000000000000008fa8233fb2c1280000fca11b85ac641f1ba215259566d579a45519e5060270d8005e3c8c7e383fe35fa40156042f3393449f20fca11b85ac641f1ba215259566d579a45519e5060000000000000000000000000000000001bc400549d3f7543335cf38fa10889ccff10207e22110b570d8005e3c8c7e383fe35fa40156042f3393449f2270d8005e3c8c7e383fe35fa40156042f3393449f0000000000000000000000000000000049d3f7543335cf38fa10889ccff10207e22110b5006000a400a718a9000000000000000000000000951857744785e80e2de051c32ee7b25f9c458c4200000000000000000000000049d3f7543335cf38fa10889ccff10207e22110b5000000000000000000000000be8a9c1792d00e75b898099f235fc40924d87735000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004001951857744785e80e2de051c32ee7b25f9c458c42cb6eb8df68153cebf60e1872273ef52075a5c29700000000000000000000000000000000004001fa2958cb79b0491cc627c1557f441ef849ca8eb1444444131db4dd4a6752cf83321d4b203342fd2b0000000000000000000000000000000000400149d3f7543335cf38fa10889ccff10207e22110b5444444131db4dd4a6752cf83321d4b203342fd2b00000000000000000000000000000000004001951857744785e80e2de051c32ee7b25f9c458c425854b550482dc2785c9c4ecdb235076b5e1d75b70100000000000006168a6643f8c07800004001951857744785e80e2de051c32ee7b25f9c458c4229f804974da123e8e48acb107be76b9f2ce1b4080100000000000006168a6643f8c07800004001fa2958cb79b0491cc627c1557f441ef849ca8eb1444444131db4dd4a6752cf83321d4b203342fd2b0000000000000000000000000000000000400149d3f7543335cf38fa10889ccff10207e22110b5444444131db4dd4a6752cf83321d4b203342fd2b00000000000000000000000000000000004001951857744785e80e2de051c32ee7b25f9c458c42444444131db4dd4a6752cf83321d4b203342fd2b00000000000000000000000000000000004001fa2958cb79b0491cc627c1557f441ef849ca8eb1444444131db4dd4a6752cf83321d4b203342fd2b0000000000000000000000000000000000400149d3f7543335cf38fa10889ccff10207e22110b5444444131db4dd4a6752cf83321d4b203342fd2b0000000000000000000000000000000000000000";
    }

    function getParams2() internal pure returns (bytes memory d, uint256 value) {
        value = 0.0e18;
        d =
            hex"10000000000000017672bcd44a8e6f000000000000000000000000000000000001951857744785e80e2de051c32ee7b25f9c458c4200008f9920283470f52128bf11b0c14e798be704fd15cb6eb8df68153cebf60e1872273ef52075a5c29700559f2558d308c300e8427895b32b71ece506ab69000bb800f2100000000000000000000000000000000000000000000000000000000014754a8a8f9920283470f52128bf11b0c14e798be704fd150000fa2958cb79b0491cc627c1557f441ef849ca8eb1cb6eb8df68153cebf60e1872273ef52075a5c29700df0ad7c95effa35d0b1d4258e3e256a5d1ab2a640001f4000110000000000000046358367cdfab4d00000000000000000000000000003d3fe39a951857744785e80e2de051c32ee7b25f9c458c420000fa2958cb79b0491cc627c1557f441ef849ca8eb1cb6eb8df68153cebf60e1872273ef52075a5c2974152297f3e1f099da7f4fc0a66bc8732016ab3f9b100010200034001951857744785e80e2de051c32ee7b25f9c458c42777777f7447c10c1360926d282ff218100ca279a00000000000000000000000000000000004001fa2958cb79b0491cc627c1557f441ef849ca8eb1777777f7447c10c1360926d282ff218100ca279a0000000000000000000000000000000000400149d3f7543335cf38fa10889ccff10207e22110b5777777f7447c10c1360926d282ff218100ca279a0000000000000000000000000000000000";
    }
}
