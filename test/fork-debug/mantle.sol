// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.19;

import {IERC20All} from "test/shared/interfaces/IERC20All.sol";
import {BaseTest} from "test/shared/BaseTest.sol";
import {Chains, Tokens, Lenders} from "test/data/LenderRegistry.sol";
import "contracts/utils/CalldataLib.sol";
import {console} from "forge-std/console.sol";
import {ComposerPlugin, IComposerLike} from "plugins/ComposerPlugin.sol";

import "contracts/external-protocols/misc/FeeOnTransferDetector.sol";
import "./FOT.sol";

// solhint-disable max-line-length

interface IA {
    function upgradeAndCall(address proxy, address implementation, bytes memory data) external;
}

contract ForkTestMantle is BaseTest {
    IComposerLike oneDV2;

    address admin = 0xe717cF8aFFA37c6e03C986452a19348Ab6Cb6197;
    address owner = 0x999999833d965c275A2C102a4Ebf222ca938546f;
    address proxy = 0x5C019a146758287C614FE654CaEC1ba1CaF05F4E;

    address mockSender = 0x91ae002a960e63Ccb0E5bDE83A8C13E51e1cB91A;
    // address mockSender = 0xdFF70A71618739f4b8C81B11254BcE855D02496B;

    uint256 internal constant forkBlock = 0;

    function setUp() public virtual {
        // initialize the chain
        string memory chainName = Chains.MANTLE;

        _init(chainName, forkBlock, true);

        oneDV2 = ComposerPlugin.getComposer(chainName);

        vm.prank(owner);
        IA(admin).upgradeAndCall(proxy, address(oneDV2), hex"");

        labelAddresses();
    }

    function labelAddresses() internal {
        vm.label(owner, "owner");
        vm.label(admin, "admin");
        vm.label(proxy, "proxy");
        vm.label(address(oneDV2), "Composer");
        vm.label(mockSender, "MeMeMeMe");
    }

    function test_fork_raw_mantle_swap() external {
        vm.prank(address(0xbadA9c382165b31419F4CC0eDf0Fa84f80A3C8E5));
        address(proxy).call{value: 0.0}(getData());
    }

    function test_fork_params_mantle() external {
        vm.prank(mockSender);
        (bytes memory params, uint256 value) = getParams2();
        IComposerLike(proxy).deltaCompose{value: value}(params);
    }

    // nonce 0n
    // cometCreditPermit.ts:120 expiry 1748970849
    // cometCreditPermit.ts:121 v,r,s 27n 0x8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f 0x16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab
    // cometCreditPermit.ts:126 r 8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f
    // cometCreditPermit.ts:127 vs 16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab

    function getData() internal pure returns (bytes memory d) {
        d =
            hex"17d7309100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000f854005deaddeaddeaddeaddeaddeaddeaddeaddead1111cfa5ae7c2ce8fadc6426c1ff872ca45378fb7cf36003deaddeaddeaddeaddeaddeaddeaddeaddead1111cfa5ae7c2ce8fadc6426c1ff872ca45378fb7cf30000000000000000000063f4575f17ea0f1f014001deaddeaddeaddeaddeaddeaddeaddeaddead1111fca1154c643c32638aee9a43eee7f377f515c801010000000000000000000063f4575f17ea20fca1154c643c32638aee9a43eee7f377f515c801000000000000000000000000000000000d754005deaddeaddeaddeaddeaddeaddeaddeaddead1111888888888889758f76e7103c6cbf23abbf58f94620888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000000000000d24d0f423850000000000000000000000005c019a146758287c614fe654caec1ba1caf05f4e000000000000000000000000affe4b1b1eebe6dd1ee31ad27c88a918825c89f800000000000000000000000000000000000000000000000000006443ccfbdd650000000000000000000000000000000000000000000000000000000000000080000000000000000000000000deaddeaddeaddeaddeaddeaddeaddeaddead1111000000000000000000000000000000000000000000000000000063f4575f17ea000000000000000000000000e6829d9a7ee3040e1276fa75293bde931859e8fa000000000000000000000000d4f480965d2347d421f1bec7f545682e5ec2151d00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006131b5fae19ea4f9d964eac0408e4408b66337b5000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b44e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000062000000000000000000000000000000000000000000000000000000000000008600000000000000000000000000000000000000000000000000000000000000560000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000deaddeaddeaddeaddeaddeaddeaddeaddead1111000000000000000000000000e6829d9a7ee3040e1276fa75293bde931859e8fa000000000000000000000000888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000000000000000000000000000000000007fffffff0000000000000000000000000000000000000000000000000000000000000500000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000002e0000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca30000000000000000000000003fad6235f42e64fe0771031bb5917831f2d0acac000000000000000000000000deaddeaddeaddeaddeaddeaddeaddeaddead1111000000000000000000000000201eba5cc46d216ce6dc03f6a759e8e766e956ae000000000000000000000000000000000000000000000000000063f4575f17ea000000000000000000000000ff53611968f1e5ca45cfca7918447e7f5776f6d30000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca30000000000000000000000004247f6c7409832adc101d7df714f96fecb327c92000000000000000000000000201eba5cc46d216ce6dc03f6a759e8e766e956ae00000000000000000000000078c1b0c915c4faa5fffa6cabf0219da63d7f4cb80000000000000000000000000000000000000000000000000000000000060ce300000000000000000000000000000000000000000000000000000001000276a4000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000405987cf430000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000a00000000000000000000000005520385bfcf07ec87c4c53a7d8d65595dff69fa400000000000000000000000078c1b0c915c4faa5fffa6cabf0219da63d7f4cb8000000000000000000000000e6829d9a7ee3040e1276fa75293bde931859e8fa00000000000000000000000000000000000000000000000006e73a7de18670ef0000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca3000000000000000000000000000000000000000000000000000000000000002000000000000000000000000006327db9000000000000000000005e8feee5da1f000000000000000000000000deaddeaddeaddeaddeaddeaddeaddeaddead1111000000000000000000000000e6829d9a7ee3040e1276fa75293bde931859e8fa000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000888888888889758f76e7103c6cbf23abbf58f946000000000000000000000000000000000000000000000000000063f4575f17ea00000000000000000000000000000000000000000000000000005d9dda96c0e50000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca30000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000063f4575f17ea00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002827b22536f75726365223a2250656e646c65222c22416d6f756e74496e555344223a22302e33393531353039323033383336383333222c22416d6f756e744f7574555344223a22302e34303036393931383236323531343231222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a22313033393732323831333735323632222c2254696d657374616d70223a313735333239363434312c22526f7574654944223a2265616337383031332d613163372d343962372d393336352d3834373066616164623531353a61326639353632332d376162302d343037312d613834612d303136363231316236636332222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a224d53363871426639326d51794c65514c524a49426e37374c4f3870666264444b7a4154467064776a4b38424456616166336f42344966327079316f496d4d364c4d54636a7759394e42437057616d6a4331323846436977744a776d4761764a30634953342b57745358366334317450522f7532797a4f316f663470585841726b2b7465432f7934426f706575673355505271306d545239564e57414d4e5a42424e7a677678456c7731776f4f42383072444c792f693956316d397359697863516e6645502f456738654e65464849684754796f767132626f736b5558465435797777333444417456574d44512b505758554b6c32636975657341766f344641623675744b6b50624d39674355547752666c6d666f682b3862304e6b624e562f4579767839513654345950446f49716a49696a422f564e55346a55792b79534e44336d33556c64583146644f54342f75515752335a4d773d3d227d7d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004005698eb002a4ec013a33286f7f2ba0be3970e664555d7b73f9271c40ff737f98b8f818e7477761041f300003e7698eb002a4ec013a33286f7f2ba0be3970e6645500000000000000000000000000000000bada9c382165b31419f4cc0edf0fa84f80a3c8e55d7b73f9271c40ff737f98b8f818e7477761041f500146897b857f7b4423bdace4b6a214afefd02deff9006400000000000000000000000000000000000000000000000000006424fb6fac0168813ba939af3a14c746ae2ae58cb8de2bb7574d992351702867cab51b9dadc3127d386411f209a1afbed9e118c7e264fb594f34ec9ab1f2404d6b0e7c113190ad83b38f300103e7deaddeaddeaddeaddeaddeaddeaddeaddead111100000000000000000000640b5eece0005c019a146758287c614fe654caec1ba1caf05f4e025d7b73f9271c40ff737f98b8f818e7477761041f000000000000000000000000000000000000000000000000000000";
    }

    function getParams2() internal pure returns (bytes memory d, uint256 value) {
        value = 0;
        d =
            hex"100000000000000006fab6b9106fe461a900000000000000000108093d7c88eb5e186573b175adf5801cf95fb06b232ccab123c6f4010002000000420000000000000000000000000000000000000af5988809ac97c65121e2c34f5d49558e3d12c253036d2d52d788a5eab4009dc4e039505212f444bf6426f28200000000ea32a96608495e54156ae48931a7c20f0dcc1a21ef874fede49cf49940e8c472f3e58e75ea65b34c01f5988809ac97c65121e2c34f5d49558e3d12c25326f2000002000075cb093e4d61d2a2e65d8e0bbb01de8d89b53481ce434378adacc51d54312c872113d687ac19b51601ef874fede49cf49940e8c472f3e58e75ea65b34c26f28200020000000000000000000000000000000000000000000091ae002a960e63ccb0e5bde83a8c13e51e1cb91afe0001";
    }
}
