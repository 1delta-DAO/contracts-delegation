// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.19;

import {IERC20All} from "test/shared/interfaces/IERC20All.sol";
import {BaseTest} from "test/shared/BaseTest.sol";
import {Chains, Tokens, Lenders} from "test/data/LenderRegistry.sol";
import "contracts/utils/CalldataLib.sol";
import {console} from "forge-std/console.sol";
import {ComposerPlugin, IComposerLike} from "plugins/ComposerPlugin.sol";

import "../../../contracts/external-protocols/misc/FeeOnTransferDetector.sol";
import "./FOT.sol";

// solhint-disable max-line-length

interface IA {
    function upgradeAndCall(address proxy, address implementation, bytes memory data) external;
}

contract ForkTestPolygon is BaseTest {
    IComposerLike oneDV2;

    address admin = 0xdAf4eA0785E33F710A186CA5330Bd26837f96765;
    address owner = 0x999999833d965c275A2C102a4Ebf222ca938546f;
    address proxy = 0xFd245e732b40b6BF2038e42b476bD06580585326;

    // address mockSender = 0x448CC254819520BF086BCf01245982fAB75c3F66;
    address mockSender = 0xbadA9c382165b31419F4CC0eDf0Fa84f80A3C8E5;

    uint256 internal constant forkBlock = 0;

    function setUp() public virtual {
        // initialize the chain
        string memory chainName = Chains.POLYGON_MAINNET;

        _init(chainName, forkBlock, true);

        oneDV2 = ComposerPlugin.getComposer(chainName);

        vm.prank(owner);
        IA(admin).upgradeAndCall(proxy, address(oneDV2), hex"");

        labelAddresses();
    }

    function labelAddresses() internal {
        vm.label(owner, "owner");
        vm.label(admin, "admin");
        vm.label(proxy, "proxy");
        vm.label(address(oneDV2), "Composer");
        vm.label(mockSender, "MeMeMeMe");
    }

    function test_fork_raw_polygon_swap() external {
        vm.prank(mockSender);
        address(proxy).call(getData());
    }

    function test_fork_params_polygon() external {
        vm.prank(mockSender);
        (bytes memory params, uint256 value) = getParams2();
        IComposerLike(proxy).deltaCompose{value: value}(params);
    }

    // nonce 0n
    // cometCreditPermit.ts:120 expiry 1748970849
    // cometCreditPermit.ts:121 v,r,s 27n 0x8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f 0x16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab
    // cometCreditPermit.ts:126 r 8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f
    // cometCreditPermit.ts:127 vs 16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab

    function getData() internal pure returns (bytes memory d) {
        d =
            hex"17d7309100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000e844005c2132d05d31c914a87c6611c10748aeb04b58e8f1bf0c2541f820e775182832f06c0b7fc27a25f676000c2132d05d31c914a87c6611c10748aeb04b58e8f1bf0c2541f820e775182832f06c0b7fc27a25f670000000000000000000000000014871f0de3004001c2132d05d31c914a87c6611c10748aeb04b58e8ffca1150ea45ba50323c27a7d5e823d92d2e59a05010000000000000000000000000014871f20fca1150ea45ba50323c27a7d5e823d92d2e59a05000000000000000000000000000000000cb54005c2132d05d31c914a87c6611c10748aeb04b58e8f6131b5fae19ea4f9d964eac0408e4408b66337b5206131b5fae19ea4f9d964eac0408e4408b66337b5000000000000000000000000000000000c64e21fd0e9000000000000000000000000000000000000000000000000000000000000002000000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000740000000000000000000000000000000000000000000000000000000000000098000000000000000000000000000000000000000000000000000000000000006800000000000000000000000000014871f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000041429837fd3704f7523926bbdf0658bc6b7f361ff5be854f4f25734823953b69de59cd349c78baa7b9a96dab5391143a7c5587f0c2e41f562104a0af8bf1bfe9ee1b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000580000000000000000000000000fd245e732b40b6bf2038e42b476bd06580585326000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000013805d00000000000000000000000000158de00000000000000000000000000014871f00000000000000000001244c9f84e7be000000000000000000000000000000000000001327f7f90000000f42400000000000000000000000000000004f82e73edb06d29ff62c91ec8f5ff06571bdeb29000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000029e8d608000000000000000000000000000000000000000000000000000000000000000560000000000000000000000000000000000000000000000000000000000000000161f598cd000000000000000092934e8915576ff4684cad10ee82dfe788e9250c0000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000340000000000000000000000000c2132d05d31c914a87c6611c10748aeb04b58e8f800000000000000000000000000000010000000000000000000000000014871f000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000014871fc699355600000000000000015455c918e405a2831fbff8595c0aae35ee3db9d1000000000000000000000000000000000000000000000000000000000000008000000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb000000000000000000000000000000000000000000000000000000000000000200000001e00000000000027103904ac366d348636694cb6720aa1540e76441b1b0000000000000000000000002791bca1f2de4661ed88a30c99a7a9449aa8417480000000000000000000000000000001000000000000000000000000001486b500000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000001486b56d2472ce00000000000100025455c918e405a2831fbff8595c0aae35ee3db9d1000000000000000000000000000000000000000000000000000000000000008000000000000000000000000063242a4ea82847b20e506b63b0e2e2eff0cc6cb00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000ba12222222228d8ba445958a75a0704d566bf2c810f21c9bd8128a29aa785ab2de0d044dcdd794360002000000000000000000590000000000000000000000007ceb23fd6bc0add59e62ac25578270cff1b9f6198000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c2132d05d31c914a87c6611c10748aeb04b58e8f0000000000000000000000007ceb23fd6bc0add59e62ac25578270cff1b9f619000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000fd245e732b40b6bf2038e42b476bd06580585326000000000000000000000000000000000000000000000000000000000014871f0000000000000000000000000000000000000000000000000001228ba6c109290000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000003904ac366d348636694cb6720aa1540e76441b1b0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000014871f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002897b22536f75726365223a226e756c6c3a6c6f63616c686f7374222c22416d6f756e74496e555344223a22312e33343437383638333730353533373335222c22416d6f756e744f7574555344223a22312e333436343430323436383932333937222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a22333231333836343839313132353039222c2254696d657374616d70223a313736313538323334392c22526f7574654944223a2236336133353966372d333531662d343363372d393165302d3431633461363165383037353a66353335323037342d326433612d343062382d626461652d323736306465393237393465222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a224f6c617a4a4c545554676e4b576b62383344554944716c78574d5332515a3549662b317035503359704d6b50753538743262433255634f5674756d693068566d5966376f4b37346d6434744864382b36445a4a4d414e7a55553941552b6e724a51317a37506776754473736376485838457a6a5178516548466b347559343951452b69474a2b72506c4d43476f785968584c6a4c327133486e337072624e58587771676e764e4a6b766c6275684b69764572757464447759576835707a704667692f4c4244304251463436397765646b6c4a623455524d323749793731486e33676a502b6944582f717a66347141533469675852306b3756566e57716e647630494748626b464c457a705932437742764564525942517977674c434e6a3577443668362f5a7759733155692f47634a645a4f58506b712b506e737451423966496e584d676c73724f5979746770514e6c7458336e47773d3d227d7d000000000000000000000000000000000000000000000040057ceb23fd6bc0add59e62ac25578270cff1b9f619aeb318360f27748acb200ce616e389a6c9409a0730000bb77ceb23fd6bc0add59e62ac25578270cff1b9f61900000000000000000000000000000000bada9c382165b31419f4cc0edf0fa84f80a3c8e5aeb318360f27748acb200ce616e389a6c9409a0730030bb7c2132d05d31c914a87c6611c10748aeb04b58e8f0000fffffffffffffffffffffffffffffd245e732b40b6bf2038e42b476bd0658058532601aeb318360f27748acb200ce616e389a6c9409a074001c2132d05d31c914a87c6611c10748aeb04b58e8fbada9c382165b31419f4cc0edf0fa84f80a3c8e5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
    }

    function getParams2() internal pure returns (bytes memory d, uint256 value) {
        value = 0;
        d =
            hex"1000000000000000000000086954db3b6b000000000000000000000000000000017ceb23fd6bc0add59e62ac25578270cff1b9f61900000d500b1d8e8ef31e21c99d1db9a6444d3adf1270fd245e732b40b6bf2038e42b476bd06580585326001a34eabbe928bf431b679959379b2225d60d9cda0d01f406ca1000000000000000000000000000000000000000000000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000d6df932a45c0f255f85145f286ea0b292b21c90bfd245e732b40b6bf2038e42b476bd0658058532600b3866eb993e1aef93f219c3da0a71c3f11becbf20001f40001100000000000000000000010d2a9b676d7000000000000000000000000000000017ceb23fd6bc0add59e62ac25578270cff1b9f61900000d500b1d8e8ef31e21c99d1db9a6444d3adf1270fd245e732b40b6bf2038e42b476bd0658058532600479e1b71a702a595e19b6d5932cd5c863ab57ee0006bb905d81000000000000000000000000000000000000000000000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf1270010000008f3cf7ad23cd3cadbd9735aff958023239c6a063fd245e732b40b6bf2038e42b476bd06580585326000f663c16dd7c65cf87edb9229464ca77aeea536b0001f400010000d6df932a45c0f255f85145f286ea0b292b21c90bfd245e732b40b6bf2038e42b476bd0658058532600d20f057b05f1d62c1fe306f6ee77ab4c8fd7e2fb000bb80001100000000000000000000010d2a9b676d7000000000000000000000000000000017ceb23fd6bc0add59e62ac25578270cff1b9f61900000d500b1d8e8ef31e21c99d1db9a6444d3adf1270fd245e732b40b6bf2038e42b476bd065805853260086f1d8390222a3691c28938ec7404a1661e618e00001f404a01000000000000000000000000000000000000000000000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000d6df932a45c0f255f85145f286ea0b292b21c90bfd245e732b40b6bf2038e42b476bd0658058532601b2bb7c1c176ba8f2ef4230e28175b841e60ef69226f20000011000000000000000000000193bfe91b242000000000000000000000000000000017ceb23fd6bc0add59e62ac25578270cff1b9f61900000d500b1d8e8ef31e21c99d1db9a6444d3adf1270fd245e732b40b6bf2038e42b476bd065805853260162fc1e1fdabc0c9f2b096019e2d98204da049457270b8603ae1000000000000000000000000000000000000000000000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000d6df932a45c0f255f85145f286ea0b292b21c90bfd245e732b40b6bf2038e42b476bd065805853260142ed6d85ccf43859cbc46f6efa1f21e21cc2403026fc0c0001100000000000000000000064effa46c90a000000000000000000000000000000007ceb23fd6bc0add59e62ac25578270cff1b9f6190000d6df932a45c0f255f85145f286ea0b292b21c90bfd245e732b40b6bf2038e42b476bd065805853260025fb97799f80433e422f47e75173314e54dae1740001f402bc4005d6df932a45c0f255f85145f286ea0b292b21c90b794a61358d6845594f94dc1db02a252b5b4814ad300003e7d6df932a45c0f255f85145f286ea0b292b21c90b00000000000000000000000000000000448cc254819520bf086bcf01245982fab75c3f66794a61358d6845594f94dc1db02a252b5b4814ad5000e50fa9b3c56ffb159cb0fca61f5c9d750e8128c800640000000000000000000000000000000000000000000000000000a865b22f44506850767516b30f31b315be0973d988b16cc43cf0998b859fa165bc5e2a157e5161a23a7d46dc09895f33a6b48339352e92a1574153aba698173ad7ea86c538c6368c75d7300303e77ceb23fd6bc0add59e62ac25578270cff1b9f6190000fffffffffffffffffffffffffffffd245e732b40b6bf2038e42b476bd06580585326e50fa9b3c56ffb159cb0fca61f5c9d750e8128c8794a61358d6845594f94dc1db02a252b5b4814ad40017ceb23fd6bc0add59e62ac25578270cff1b9f61925fb97799f80433e422f47e75173314e54dae174010000000000000000000064effa46c90a40017ceb23fd6bc0add59e62ac25578270cff1b9f61962fc1e1fdabc0c9f2b096019e2d98204da0494570100000000000000000000193bfe91b24240017ceb23fd6bc0add59e62ac25578270cff1b9f61986f1d8390222a3691c28938ec7404a1661e618e0010000000000000000000010d2a9b676d740017ceb23fd6bc0add59e62ac25578270cff1b9f619479e1b71a702a595e19b6d5932cd5c863ab57ee0010000000000000000000010d2a9b676d740017ceb23fd6bc0add59e62ac25578270cff1b9f6191a34eabbe928bf431b679959379b2225d60d9cda0100000000000000000000086954db3b6b40017ceb23fd6bc0add59e62ac25578270cff1b9f619448cc254819520bf086bcf01245982fab75c3f660000000000000000000000000000000000";
    }
}
