// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.19;

import {IERC20All} from "test/shared/interfaces/IERC20All.sol";
import {BaseTest} from "test/shared/BaseTest.sol";
import {Chains, Tokens, Lenders} from "test/data/LenderRegistry.sol";
import "test/composer/utils/CalldataLib.sol";
import {console} from "forge-std/console.sol";
import {ComposerPlugin, IComposerLike} from "plugins/ComposerPlugin.sol";

import "../../../contracts/external-protocols/misc/FeeOnTransferDetector.sol";
import "./FOT.sol";

// solhint-disable max-line-length

interface IA {
    function upgradeAndCall(address proxy, address implementation, bytes memory data) external;
}

contract ForkTestSOnic is BaseTest {
    IComposerLike oneDV2;

    address admin = 0xBb7EAaAF2C7208384F6297C2b73935D257698c78;
    address owner = 0x999999833d965c275A2C102a4Ebf222ca938546f;
    address proxy = 0x8E24CfC19c6C00c524353CB8816f5f1c2F33c201;

    address mockSender = 0xbadA9c382165b31419F4CC0eDf0Fa84f80A3C8E5;
    // address mockSender = 0xdFF70A71618739f4b8C81B11254BcE855D02496B;

    uint256 internal constant forkBlock = 22102013;

    function setUp() public virtual {
        // initialize the chain
        string memory chainName = Chains.SCROLL;

        _init(chainName, forkBlock, true);

        oneDV2 = ComposerPlugin.getComposer(chainName);

        vm.prank(owner);
        IA(admin).upgradeAndCall(proxy, address(oneDV2), hex"");

        labelAddresses();
    }

    function labelAddresses() internal {
        vm.label(owner, "owner");
        vm.label(admin, "admin");
        vm.label(proxy, "proxy");
        vm.label(address(oneDV2), "Composer");
        vm.label(mockSender, "MeMeMeMe");
    }

    function test_fork_raw_scroll_swap() external {
        vm.prank(mockSender);
        address(proxy).call{value: 0.001e18}(getData());
    }

    function test_fork_params_scroll() external {
        vm.prank(mockSender);
        (bytes memory params, uint256 value) = getParams2();
        IComposerLike(proxy).deltaCompose{value: value}(params);
    }

    // nonce 0n
    // cometCreditPermit.ts:120 expiry 1748970849
    // cometCreditPermit.ts:121 v,r,s 27n 0x8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f 0x16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab
    // cometCreditPermit.ts:126 r 8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f
    // cometCreditPermit.ts:127 vs 16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab

    function getData() internal pure returns (bytes memory d) {
        d =
            hex"17d730910000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000099640010000000000000000000000000000000000000000530000000000000000000000000000000000000401000000000000000000038d7ea4c6800040015300000000000000000000000000000000000004fca11d8c816f8e52f55d5d9858deee78f152d90301000000000000000000038d7ea4c68000400553000000000000000000000000000000000000042d012edbadc37edc2bc62791b666f9193fdf5a55600053000000000000000000000000000000000000042d012edbadc37edc2bc62791b666f9193fdf5a5500000000000000000019945ca262000008ba0040015300000000000000000000000000000000000004fca11d8c816f8e52f55d5d9858deee78f152d9030100000000000000000019945ca262000020fca11d8c816f8e52f55d5d9858deee78f152d9030000000000000000000000000000000007104005530000000000000000000000000000000000000481bbba46b9fcf04ab13314136b895b15291f04622081bbba46b9fcf04ab13314136b895b15291f0462000000000000000000000000000000000684e3665a43000000000000000000000000000000000000000000000000001d21db4728800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000bb80000000000000000000000005300000000000000000000000000000000000004000000000000000000000000daf87a186345f26d107d000fad351e79ff696d2c00000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000058435f104010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000001d21db472880000000000000000000000000000000000000000000000000000017e5ee83ede83f00000000000000000000000000000000000000000000000000180adc61b313e2000000000000000000000000000000000000000000000000000001d1a94a200000000000000000000000000000000000000000000000000000000000000001400000000000000000000000008e24cfc19c6c00c524353cb8816f5f1c2f33c20100000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000000020000000000000000000000005300000000000000000000000000000000000004000000000000000000000000f610a9dfb7c89644979b4a0f27063e9e7d7cda3200000000000000000000000000000000000000000000000000000000000000067fff7fff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000010000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000012436fdf363000000000000000000000000000000000000000000000000000e90eda394400000000000000000000000000080e38291e06339d10aab483c65695d004dbd5c6900000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003000000000000000000000000530000000000000000000000000000000000000400000000000000000000000037bac764494c8db4e54bde72f6965bea9fa0ac2d000000000000000000000000f610a9dfb7c89644979b4a0f27063e9e7d7cda3200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e4f4e9ba15000000000000000000000000000000000000000000000000000e90eda3944000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003f53000000000000000000000000000000000000048c7d3063579bdb0b90997e18a770eae32e1ebb080001f4f610a9dfb7c89644979b4a0f27063e9e7d7cda320000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004001f610a9dfb7c89644979b4a0f27063e9e7d7cda328e24cfc19c6c00c524353cb8816f5f1c2f33c20100000000000000000000000000000000004005f610a9dfb7c89644979b4a0f27063e9e7d7cda3211fcfe756c05ad438e312a7fd934381537d3cffe300003e7f610a9dfb7c89644979b4a0f27063e9e7d7cda3200000000000000000000000000000000bada9c382165b31419f4cc0edf0fa84f80a3c8e511fcfe756c05ad438e312a7fd934381537d3cffe5001fd7344ceb1df9cf238ecd667f4a6f99c6ef44a5600640000000000000000000000000000000000000000000000000019945ca262000168d880b2a0a266e6d7d0b2bb5bba9133a6b566194f877fcd26ed830c451e455361ff19fe52ca23c704132a9de28f1c82c9eed7fd02f12f2c5f97cf638ff629efc0565373300103e7530000000000000000000000000000000000000400000000000000000019945ca26200008e24cfc19c6c00c524353cb8816f5f1c2f33c2010211fcfe756c05ad438e312a7fd934381537d3cffe00000000000000000000";
    }

    function getParams2() internal pure returns (bytes memory d, uint256 value) {
        value = 3.0e18;
        d =
            hex"17d730910000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000099640010000000000000000000000000000000000000000530000000000000000000000000000000000000401000000000000000000038d7ea4c6800040015300000000000000000000000000000000000004fca11d8c816f8e52f55d5d9858deee78f152d90301000000000000000000038d7ea4c68000400553000000000000000000000000000000000000042d012edbadc37edc2bc62791b666f9193fdf5a55600053000000000000000000000000000000000000042d012edbadc37edc2bc62791b666f9193fdf5a5500000000000000000019945ca262000008ba0040015300000000000000000000000000000000000004fca11d8c816f8e52f55d5d9858deee78f152d9030100000000000000000019945ca262000020fca11d8c816f8e52f55d5d9858deee78f152d9030000000000000000000000000000000007104005530000000000000000000000000000000000000481bbba46b9fcf04ab13314136b895b15291f04622081bbba46b9fcf04ab13314136b895b15291f0462000000000000000000000000000000000684e3665a43000000000000000000000000000000000000000000000000001d21db4728800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000bb80000000000000000000000005300000000000000000000000000000000000004000000000000000000000000daf87a186345f26d107d000fad351e79ff696d2c00000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000058435f104010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000001d21db472880000000000000000000000000000000000000000000000000000017e5ee83ede83f00000000000000000000000000000000000000000000000000180adc61b313e2000000000000000000000000000000000000000000000000000001d1a94a200000000000000000000000000000000000000000000000000000000000000001400000000000000000000000008e24cfc19c6c00c524353cb8816f5f1c2f33c20100000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000000020000000000000000000000005300000000000000000000000000000000000004000000000000000000000000f610a9dfb7c89644979b4a0f27063e9e7d7cda3200000000000000000000000000000000000000000000000000000000000000067fff7fff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000010000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000012436fdf363000000000000000000000000000000000000000000000000000e90eda394400000000000000000000000000080e38291e06339d10aab483c65695d004dbd5c6900000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003000000000000000000000000530000000000000000000000000000000000000400000000000000000000000037bac764494c8db4e54bde72f6965bea9fa0ac2d000000000000000000000000f610a9dfb7c89644979b4a0f27063e9e7d7cda3200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e4f4e9ba15000000000000000000000000000000000000000000000000000e90eda3944000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003f53000000000000000000000000000000000000048c7d3063579bdb0b90997e18a770eae32e1ebb080001f4f610a9dfb7c89644979b4a0f27063e9e7d7cda320000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004001f610a9dfb7c89644979b4a0f27063e9e7d7cda328e24cfc19c6c00c524353cb8816f5f1c2f33c20100000000000000000000000000000000004005f610a9dfb7c89644979b4a0f27063e9e7d7cda3211fcfe756c05ad438e312a7fd934381537d3cffe300003e7f610a9dfb7c89644979b4a0f27063e9e7d7cda3200000000000000000000000000000000bada9c382165b31419f4cc0edf0fa84f80a3c8e511fcfe756c05ad438e312a7fd934381537d3cffe5001fd7344ceb1df9cf238ecd667f4a6f99c6ef44a5600640000000000000000000000000000000000000000000000000019945ca262000168d880b2a0a266e6d7d0b2bb5bba9133a6b566194f877fcd26ed830c451e455361ff19fe52ca23c704132a9de28f1c82c9eed7fd02f12f2c5f97cf638ff629efc0565373300103e7530000000000000000000000000000000000000400000000000000000019945ca26200008e24cfc19c6c00c524353cb8816f5f1c2f33c2010211fcfe756c05ad438e312a7fd934381537d3cffe00000000000000000000";
    }
}

// 0xb2f481d177fb61a2c8b8b27503d3f33b5596c6b7f1dd2246e8d14a6e49487bc2000000000000000000000000000000000000000000000000000000000000001c4e
// 0xb2f481d177fb61a2c8b8b27503d3f33b5596c6b7f1dd2246e8d14a6e49487bc2bfa8d508ba63b8f460adba12ced111eda5b0a53c9cabb6b052f3e5297586154e
// 0xb2f481d177fb61a2c8b8b27503d3f33b5596c6b7f1dd2246e8d14a6e49487bc23fa8d508ba63b8f460adba12ced111eda5b0a53c9cabb6b052f3e5297586154e1c
