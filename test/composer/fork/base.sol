// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.19;

import {IERC20All} from "test/shared/interfaces/IERC20All.sol";
import {BaseTest} from "test/shared/BaseTest.sol";
import {Chains, Tokens, Lenders} from "test/data/LenderRegistry.sol";
import "test/composer/utils/CalldataLib.sol";
import {console} from "forge-std/console.sol";
import {ComposerPlugin, IComposerLike} from "plugins/ComposerPlugin.sol";

import "../../../contracts/external-protocols/misc/FeeOnTransferDetector.sol";
import "./FOT.sol";

// solhint-disable max-line-length

interface IA {
    function upgradeAndCall(address proxy, address implementation, bytes memory data) external;
}

contract ForkTestMantle is BaseTest {
    IComposerLike oneDV2;

    address admin = 0x983B147a98bEAD1d4986B4c4c74c1984d0811Eb5;
    address owner = 0x999999833d965c275A2C102a4Ebf222ca938546f;
    address proxy = 0xB7ea94340e65CC68d1274aE483dfBE593fD6f21e;

    address mockSender = 0xbadA9c382165b31419F4CC0eDf0Fa84f80A3C8E5;
    // address mockSender = 0xdFF70A71618739f4b8C81B11254BcE855D02496B;

    uint256 internal constant forkBlock = 0;

    function setUp() public virtual {
        // initialize the chain
        string memory chainName = Chains.BASE;

        _init(chainName, forkBlock, true);

        oneDV2 = ComposerPlugin.getComposer(chainName);

        vm.prank(owner);
        IA(admin).upgradeAndCall(proxy, address(oneDV2), hex"");

        labelAddresses();
    }

    function labelAddresses() internal {
        vm.label(owner, "owner");
        vm.label(admin, "admin");
        vm.label(proxy, "proxy");
        vm.label(address(oneDV2), "Composer");
        vm.label(mockSender, "MeMeMeMe");
    }

    function test_fork_raw_base_swap() external {
        vm.prank(mockSender);
        address(proxy).call{value: 0.0e18}(getData());
    }

    function test_fork_params_base() external {
        vm.prank(mockSender);
        (bytes memory params, uint256 value) = getParams2();
        IComposerLike(proxy).deltaCompose{value: value}(params);
    }

    // nonce 0n
    // cometCreditPermit.ts:120 expiry 1748970849
    // cometCreditPermit.ts:121 v,r,s 27n 0x8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f 0x16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab
    // cometCreditPermit.ts:126 r 8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f
    // cometCreditPermit.ts:127 vs 16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab

    function getData() internal pure returns (bytes memory d) {
        d =
            hex"17d73091000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000009dd400504c0599ae5a44757c0af6f9ec3b93da8976c150abbbbbbbbbb9cc5e90e3b3af64bdaf62c37eeffcb600004c0599ae5a44757c0af6f9ec3b93da8976c150abbbbbbbbbb9cc5e90e3b3af64bdaf62c37eeffcb00000000000000000000566077b84c23093c00400104c0599ae5a44757c0af6f9ec3b93da8976c150afca1154c643c32638aee9a43eee7f377f515c8010100000000000000000000566077b84c2320fca1154c643c32638aee9a43eee7f377f515c801000000000000000000000000000000000775400504c0599ae5a44757c0af6f9ec3b93da8976c150a6131b5fae19ea4f9d964eac0408e4408b66337b5206131b5fae19ea4f9d964eac0408e4408b66337b5000000000000000000000000000000000724e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000440000000000000000000000000000000000000000000000000000000000000013f010100000094000000498581ff718922c3f8e6a244956af099b2652b2b00000000000000000000566077b84c230104c0599ae5a44757c0af6f9ec3b93da8976c150a00000000000000000000566077b84c23010000000000000000000000000000000000000000000064000001000000000000000000000000000000000000000000000000fffd8963efd1fc6a506488495d951d5263988d25024c04c0599ae5a44757c0af6f9ec3b93da8976c150a4200000000000000000000000000000000000006b7ea94340e65cc68d1274ae483dfbe593fd6f21e000000000000000000000000687be17b000000540000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060ff273000000000000000000005c80d541bd0f4f82e73edb06d29ff62c91ec8f5ff06571bdeb290000000000000000000000000004c0599ae5a44757c0af6f9ec3b93da8976c150a0000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000b7ea94340e65cc68d1274ae483dfbe593fd6f21e0000000000000000000000000000000000000000000000000000566077b84c2300000000000000000000000000000000000000000000000000005b94065300490000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000566077b84c23000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028b7b22536f75726365223a226e756c6c3a6c6f63616c686f7374222c22416d6f756e74496e555344223a22302e33363035363631393937333836363932222c22416d6f756e744f7574555344223a22302e3336303539313435363737313135373935222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a22313031373038343033343234353237222c2254696d657374616d70223a313735323934373931352c22526f7574654944223a2262643464393234362d396631382d346535322d396464642d3039636238346666313261333a30633834396432642d383066382d346665622d396462612d366636653234306363346337222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a2251424b4b3377646d6c7055417959364a2f497171304f496e6e633456636b2f49342b6769597a617279646e6137756775486b524358712b6174724b50694471324c666762366838694475585864766e345576593865436335544355463930423152484f673054724662664d7a6a536a34357150496c6f454f49592f502f524e657475487a4159686f794562425143752f394e66326e2f54616b366f7848395956645a527150723775314652743079327a302f6a4554762f787450534344416a6a713262476a626876414a6a317842527765704d5664484e4152516634354c4c3148442f4d6b70626c71374b4434504b753067784c703134312b74774f34333466657a7058346a62586e6c502f6a5836795345796a62517251422b69494b503963554b306635366d716d38514e424b426a66457a77384a306d422f727765746c31423342693639492f566f4b77366848416a5857324b773d3d227d7d00000000000000000000000000000000000000000040054200000000000000000000000000000000000006bbbbbbbbbb9cc5e90e3b3af64bdaf62c37eeffcb30041388420000000000000000000000000000000000000604c0599ae5a44757c0af6f9ec3b93da8976c150ace629400c6aedb64f087cac40ae6a382aeeef49046415998764c29ab2a25cbea6254146d50d2268700000000000000000d1d507e40be800000000000000000000000000000000000bada9c382165b31419f4cc0edf0fa84f80a3c8e5bbbbbbbbbb9cc5e90e3b3af64bdaf62c37eeffcb000030031388420000000000000000000000000000000000000604c0599ae5a44757c0af6f9ec3b93da8976c150ace629400c6aedb64f087cac40ae6a382aeeef49046415998764c29ab2a25cbea6254146d50d2268700000000000000000d1d507e40be80000000ffffffffffffffffffffffffffffb7ea94340e65cc68d1274ae483dfbe593fd6f21ebbbbbbbbbb9cc5e90e3b3af64bdaf62c37eeffcb400104c0599ae5a44757c0af6f9ec3b93da8976c150abada9c382165b31419f4cc0edf0fa84f80a3c8e50000000000000000000000000000000000000000";
    }

    function getParams2() internal pure returns (bytes memory d, uint256 value) {
        value = 0;
        d =
            hex"4005c1cba3fcea344f92d9239c08c0568f6f2f0ee452bbbbbbbbbb9cc5e90e3b3af64bdaf62c37eeffcb6000c1cba3fcea344f92d9239c08c0568f6f2f0ee452bbbbbbbbbb9cc5e90e3b3af64bdaf62c37eeffcb00000000000000000001347644bec69a032a004001c1cba3fcea344f92d9239c08c0568f6f2f0ee452fca1154c643c32638aee9a43eee7f377f515c8010100000000000000000001347644bec69a20fca1154c643c32638aee9a43eee7f377f515c8010000000000000000000000000000000001274005c1cba3fcea344f92d9239c08c0568f6f2f0ee45219ceead7105607cd444f5ad10dd51356436095a12019ceead7105607cd444f5ad10dd51356436095a10000000000000000000000000000000000d683bd37f90001c1cba3fcea344f92d9239c08c0568f6f2f0ee45200020701347644bec69a070173c577b48eb8028f5c00016877b1b0c6267e0ad9aa4c0df18a547aa2f6b08d0001744d441ed6a00d59ea1e3fdbad2b10d9a869c92f0001b7ea94340e65cc68d1274ae483dfbe593fd6f21e0000000003010203003401010001020080000343ff00000000000000000000000000000000744d441ed6a00d59ea1e3fdbad2b10d9a869c92fc1cba3fcea344f92d9239c08c0568f6f2f0ee45200000000000000000000000000000000000000000000000040054200000000000000000000000000000000000006bbbbbbbbbb9cc5e90e3b3af64bdaf62c37eeffcb300213874200000000000000000000000000000000000006c1cba3fcea344f92d9239c08c0568f6f2f0ee4524a11590e5326138b514e08a9b52202d42077ca6546415998764c29ab2a25cbea6254146d50d2268700000000000000000d1d507e40be80000000ffffffffffffffffffffffffffffbada9c382165b31419f4cc0edf0fa84f80a3c8e5bbbbbbbbbb9cc5e90e3b3af64bdaf62c37eeffcb000300300313884200000000000000000000000000000000000006c1cba3fcea344f92d9239c08c0568f6f2f0ee4524a11590e5326138b514e08a9b52202d42077ca6546415998764c29ab2a25cbea6254146d50d2268700000000000000000d1d507e40be800000000000000000000001347644bec69ab7ea94340e65cc68d1274ae483dfbe593fd6f21ebbbbbbbbbb9cc5e90e3b3af64bdaf62c37eeffcb40014200000000000000000000000000000000000006bada9c382165b31419f4cc0edf0fa84f80a3c8e5000000000000000000000000000000000040014200000000000000000000000000000000000006bada9c382165b31419f4cc0edf0fa84f80a3c8e50000000000000000000000000000000000";
    }
}

// 0xb2f481d177fb61a2c8b8b27503d3f33b5596c6b7f1dd2246e8d14a6e49487bc2000000000000000000000000000000000000000000000000000000000000001c4e
// 0xb2f481d177fb61a2c8b8b27503d3f33b5596c6b7f1dd2246e8d14a6e49487bc2bfa8d508ba63b8f460adba12ced111eda5b0a53c9cabb6b052f3e5297586154e
// 0xb2f481d177fb61a2c8b8b27503d3f33b5596c6b7f1dd2246e8d14a6e49487bc23fa8d508ba63b8f460adba12ced111eda5b0a53c9cabb6b052f3e5297586154e1c
