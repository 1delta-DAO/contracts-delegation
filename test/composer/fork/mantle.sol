// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.19;

import {IERC20All} from "test/shared/interfaces/IERC20All.sol";
import {BaseTest} from "test/shared/BaseTest.sol";
import {Chains, Tokens, Lenders} from "test/data/LenderRegistry.sol";
import "test/composer/utils/CalldataLib.sol";
import {console} from "forge-std/console.sol";
import {ComposerPlugin, IComposerLike} from "plugins/ComposerPlugin.sol";

import "../../../contracts/external-protocols/misc/FeeOnTransferDetector.sol";
import "./FOT.sol";

// solhint-disable max-line-length

interface IA {
    function upgradeAndCall(address proxy, address implementation, bytes memory data) external;
}

contract ForkTestMantle is BaseTest {
    IComposerLike oneDV2;

    address admin = 0xe717cF8aFFA37c6e03C986452a19348Ab6Cb6197;
    address owner = 0x999999833d965c275A2C102a4Ebf222ca938546f;
    address proxy = 0x5C019a146758287C614FE654CaEC1ba1CaF05F4E;

    address mockSender = 0x91ae002a960e63Ccb0E5bDE83A8C13E51e1cB91A;
    // address mockSender = 0xdFF70A71618739f4b8C81B11254BcE855D02496B;

    uint256 internal constant forkBlock = 0;

    address internal constant factory = 0xF38E7c7f8eA779e8A193B61f9155E6650CbAE095;
    bool internal constant isSolidly = false;
    bytes32 internal constant codeHash = 0xa856464ae65f7619087bc369daaf7e387dae1e5af69cfa7935850ebf754b04c1;

    function setUp() public virtual {
        // initialize the chain
        string memory chainName = Chains.MANTLE;

        _init(chainName, forkBlock, true);

        oneDV2 = ComposerPlugin.getComposer(chainName);

        vm.prank(owner);
        IA(admin).upgradeAndCall(proxy, address(oneDV2), hex"");

        labelAddresses();
    }

    function labelAddresses() internal {
        vm.label(owner, "owner");
        vm.label(admin, "admin");
        vm.label(proxy, "proxy");
        vm.label(address(oneDV2), "Composer");
        vm.label(mockSender, "MeMeMeMe");
    }

    function test_fork_raw_mantle_swap() external {
        vm.prank(mockSender);
        address(proxy).call(getData());
    }

    function test_fork_params_mantle() external {
        vm.prank(mockSender);
        (bytes memory params, uint256 value) = getParams2();
        IComposerLike(proxy).deltaCompose{value: value}(params);
    }

    // nonce 0n
    // cometCreditPermit.ts:120 expiry 1748970849
    // cometCreditPermit.ts:121 v,r,s 27n 0x8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f 0x16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab
    // cometCreditPermit.ts:126 r 8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f
    // cometCreditPermit.ts:127 vs 16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab

    function getData() internal pure returns (bytes memory d) {
        d =
            hex"17d7309100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000d69400578c1b0c915c4faa5fffa6cabf0219da63d7f4cb8cfa5ae7c2ce8fadc6426c1ff872ca45378fb7cf3600378c1b0c915c4faa5fffa6cabf0219da63d7f4cb8cfa5ae7c2ce8fadc6426c1ff872ca45378fb7cf30000000000000000455398767d362dae0d0301400178c1b0c915c4faa5fffa6cabf0219da63d7f4cb8fca1154c643c32638aee9a43eee7f377f515c801010000000000000000455398767d362dae20fca1154c643c32638aee9a43eee7f377f515c801000000000000000000000000000000000bd5400578c1b0c915c4faa5fffa6cabf0219da63d7f4cb86131b5fae19ea4f9d964eac0408e4408b66337b5206131b5fae19ea4f9d964eac0408e4408b66337b5000000000000000000000000000000000b848af033fb0000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca30000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000028000000000000000000000000000000000000000000000000000000000000008c000000000000000000000000078c1b0c915c4faa5fffa6cabf0219da63d7f4cb8000000000000000000000000deaddeaddeaddeaddeaddeaddeaddeaddead11110000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000005c019a146758287c614fe654caec1ba1caf05f4e000000000000000000000000000000000000000000000000455398767d362dae0000000000000000000000000000000000000000000000000004737f5f439faf000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000620000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000684dc0b800000000000000000000000000000000000000000000000000000000000005c00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000a375ea3e1f92d62e3a71b668bab09f7155267fa30000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000455398767d362dae00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000004059361199000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000100000000000000000000000000a375ea3e1f92d62e3a71b668bab09f7155267fa300000000000000000000000078c1b0c915c4faa5fffa6cabf0219da63d7f4cb8000000000000000000000000cda86a272531e8640cd7f1a92c01839911b90bb00000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000003e8000000000000000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000000405987cf430000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000a00000000000000000000000005520385bfcf07ec87c4c53a7d8d65595dff69fa4000000000000000000000000cda86a272531e8640cd7f1a92c01839911b90bb0000000000000000000000000201eba5cc46d216ce6dc03f6a759e8e766e956ae000000000000000000000000000000000000000000000000000433ace1e66a260000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca3000000000000000000000000000000000000000000000000000000000000004063407a490000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000f4a1d7fdf4890be35e71f3e0bbc4a0ec377eca3000000000000000000000000425732f412f2a922156cf3c135a516c18f977cc1000000000000000000000000201eba5cc46d216ce6dc03f6a759e8e766e956ae000000000000000000000000deaddeaddeaddeaddeaddeaddeaddeaddead111100000000000000000000000000000000000000000000000000000000003082f000000000000000000000000000000000000000000000000000000001004a977f000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000004b6eb419000000000000000000047f01f39ecfd8000000000000000000000000000000000000000000000000000000000000028a7b22536f75726365223a226e756c6c3a6c6f63616c686f7374222c22416d6f756e74496e555344223a22332e31383138343638373736313132323235222c22416d6f756e744f7574555344223a22332e313937363831363230333137303134222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2231323635353436323635383038383536222c2254696d657374616d70223a313734393932343837322c22526f7574654944223a2238643433353539342d303262352d346666392d616532642d6662393464623133373863363a36626635613064342d336134352d343965642d393534342d316437653463376534633333222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a2264503330745965433536614e7466304262664a61724744354976627a2f566a314d75725934334545344a584e754753637066476b50394a355038355046466636306965524677776e3573686f4e5665696b53656733784d72762b4677746739364a41535a34355650304d36434649686d514f7574334e69675752586e6e396d616842372f5348493730515730504548454b696565493479556439395143344d76615356313866442f385379707863427031664d707977704f422b656a554f6437614e4347314553506f704f6e554b7a54414166476f57636b6d7641314678694b6d757a456c704e5641454b7175423676614c575a52627944584e5141306d39744b5a7542616d34344539412b6a4a4d55313968774e664a4d41736e4f5831674d415546636a7068626d3955474c765263733069546a6b777a43417833437970314934554e5367744762687170356a742f4c75553432773d3d227d7d000000000000000000000000000000000000000000004005deaddeaddeaddeaddeaddeaddeaddeaddead1111cfa5ae7c2ce8fadc6426c1ff872ca45378fb7cf3300007cfdeaddeaddeaddeaddeaddeaddeaddeaddead11110000000000000000000000000000000091ae002a960e63ccb0e5bde83a8c13e51e1cb91acfa5ae7c2ce8fadc6426c1ff872ca45378fb7cf3300107cf78c1b0c915c4faa5fffa6cabf0219da63d7f4cb800000000000000004563918244f400005c019a146758287c614fe654caec1ba1caf05f4e02cfa5ae7c2ce8fadc6426c1ff872ca45378fb7cf30000000000000000000000000000000000000000000000";
    }

    function getParams2() internal pure returns (bytes memory d, uint256 value) {
        value = 0;
        d =
            hex"100000000000000006fab6b9106fe461a900000000000000000108093d7c88eb5e186573b175adf5801cf95fb06b232ccab123c6f4010002000000420000000000000000000000000000000000000af5988809ac97c65121e2c34f5d49558e3d12c253036d2d52d788a5eab4009dc4e039505212f444bf6426f28200000000ea32a96608495e54156ae48931a7c20f0dcc1a21ef874fede49cf49940e8c472f3e58e75ea65b34c01f5988809ac97c65121e2c34f5d49558e3d12c25326f2000002000075cb093e4d61d2a2e65d8e0bbb01de8d89b53481ce434378adacc51d54312c872113d687ac19b51601ef874fede49cf49940e8c472f3e58e75ea65b34c26f28200020000000000000000000000000000000000000000000091ae002a960e63ccb0e5bde83a8c13e51e1cb91afe0001";
    }
}
