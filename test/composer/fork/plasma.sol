// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.19;

import {IERC20All} from "test/shared/interfaces/IERC20All.sol";
import {BaseTest} from "test/shared/BaseTest.sol";
import {Chains, Tokens, Lenders} from "test/data/LenderRegistry.sol";
import "test/composer/utils/CalldataLib.sol";
import {console} from "forge-std/console.sol";
import {ComposerPlugin, IComposerLike} from "plugins/ComposerPlugin.sol";

import "../../../contracts/external-protocols/misc/FeeOnTransferDetector.sol";
import "./FOT.sol";

// solhint-disable max-line-length

interface IA {
    function upgradeAndCall(address proxy, address implementation, bytes memory data) external;
}

contract ForkTestMainnet is BaseTest {
    IComposerLike oneDV2;

    address admin = 0xBb7EAaAF2C7208384F6297C2b73935D257698c78;
    address owner = 0x999999833d965c275A2C102a4Ebf222ca938546f;
    address proxy = 0x8E24CfC19c6C00c524353CB8816f5f1c2F33c201;

    address mockSender = 0xED40933476462BDc6dDB042802CCCd950D001Bd6;
    // address mockSender = 0xdFF70A71618739f4b8C81B11254BcE855D02496B;

    uint256 internal constant forkBlock = 1897918;

    function setUp() public virtual {
        // initialize the chain
        string memory chainName = Chains.PLASMA_MAINNET;

        _init(chainName, forkBlock, true);

        oneDV2 = ComposerPlugin.getComposer(chainName);

        vm.prank(owner);
        IA(admin).upgradeAndCall(proxy, address(oneDV2), hex"");

        labelAddresses();
    }

    function labelAddresses() internal {
        vm.label(owner, "owner");
        vm.label(admin, "admin");
        vm.label(proxy, "proxy");
        vm.label(address(oneDV2), "Composer");
        vm.label(mockSender, "MeMeMeMe");
    }

    function test_fork_raw_plasma_swap() external {
        vm.prank(mockSender);
        address(proxy).call{value: 0.0e18}(getData());
    }

    function test_fork_params_plasma() external {
        vm.prank(mockSender);
        (bytes memory params, uint256 value) = getParams2();
        IComposerLike(proxy).deltaCompose{value: value}(params);
    }

    // nonce 0n
    // cometCreditPermit.ts:120 expiry 1748970849
    // cometCreditPermit.ts:121 v,r,s 27n 0x8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f 0x16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab
    // cometCreditPermit.ts:126 r 8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f
    // cometCreditPermit.ts:127 vs 16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab

    function getData() internal pure returns (bytes memory d) {
        d =
            hex"8000ba1333333333a1ba1108e8412f11850a5c319ba90acc008004ba1333333333a1ba1108e8412f11850a5c319ba99895d81bb462a195b4922ed7de0e3acd007c32cbfca11d8c816f8e52f55d5d9858deee78f152d9030000000000000000000009184e72a00020fca11d8c816f8e52f55d5d9858deee78f152d9030000000000000000000000000000000008d540059895d81bb462a195b4922ed7de0e3acd007c32cb6131b5fae19ea4f9d964eac0408e4408b66337b5206131b5fae19ea4f9d964eac0408e4408b66337b5000000000000000000000000000000000884e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000005a000000000000000000000000000000000000000000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000009895d81bb462a195b4922ed7de0e3acd007c32cb000000000000000000000000a3d68b74bf0528fdd07263c60d6488749044914b0000000000000000000000008e24cfc19c6c00c524353cb8816f5f1c2f33c2010000000000000000000000000000000000000000000000000000000068d596b80000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000401823b2c30000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000a00000000000000000000000003c0441b42195f4ad6aa9a0978e06096ea616cda7000000000000000000000000000000000000000000000000000009184e72a0000000000000000000000000009895d81bb462a195b4922ed7de0e3acd007c32cb000000000000000000000000a3d68b74bf0528fdd07263c60d6488749044914b0000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec60000000000000000000000000000000000000000000000000000000000000020000000000000000000000000008d9fb700000000000000000000087102500d6e0000000000000000000000009895d81bb462a195b4922ed7de0e3acd007c32cb000000000000000000000000a3d68b74bf0528fdd07263c60d6488749044914b000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000002000000000000000000000000008e24cfc19c6c00c524353cb8816f5f1c2f33c201000000000000000000000000000000000000000000000000000009184e72a0000000000000000000000000000000000000000000000000000000085b66212c020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec60000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000009184e72a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028a7b22536f75726365223a226e756c6c3a6c6f63616c686f7374222c22416d6f756e74496e555344223a22302e30333839323035333338313235333334222c22416d6f756e744f7574555344223a22302e303339333737343735373732333436323836222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2239323831343633313237343035222c2254696d657374616d70223a313735383832373031362c22526f7574654944223a2232633935396632302d633831312d346135642d623765372d3435653636323930656264323a38613634303965642d373266312d343863322d623635302d373063313432636362386264222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a2244367377796b742f4b436a2f49684a69754a443271304665416b765557737a6c3442786e354e6e71437a757177644c44654953486e614766584339424e5a7454447a345176704762505550544d70396a4a42483850476b5051492b472b344c74647647377645363044423950656658744445505072366f47324367775a544a536d764f564579653763456c542f796a475a6f3737396f6567786a4b6444744877636b3064355851636635464e6b6d7a69367a684a2b34674a6c33754642756e72562f637545562f424242696a6b41353665534a4b4b6c68762f634a4e56305a4f585249733746545172364e526c784e745a39694b7963332f2b4453326a463549656c48704e736235323666596b544e4558624c34414278414b464e5a6b3653347a374a58545634367963306963794366753463302f557538685770594d4a5037314f696756674c6b5578767262636e714a4b2b3441673d3d227d7d000000000000000000000000000000000000000000004005a3d68b74bf0528fdd07263c60d6488749044914b925a2a7214ed92428b5b1b090f80b25700095e12300003e7a3d68b74bf0528fdd07263c60d6488749044914b00000000000000000000000000000000ed40933476462bdc6ddb042802cccd950d001bd6925a2a7214ed92428b5b1b090f80b25700095e125001638d7db63cd5c902bdd9a91cf195870551c3c7b300640000000000000000000000000000000000000000000000000002605dbc46eff868d59ec05fcb3c92614ec2e1bf538c67ae5151e307e84e95bfc02f1b08cc3ac26550fed8aad826974ec3c579c8a2227c1acc0b4e6489fb47c7b870b30f5c9a23a42abaaa300103e79895d81bb462a195b4922ed7de0e3acd007c32cb0000000000000000000009184e72a000ba1333333333a1ba1108e8412f11850a5c319ba902925a2a7214ed92428b5b1b090f80b25700095e128005ba1333333333a1ba1108e8412f11850a5c319ba99895d81bb462a195b4922ed7de0e3acd007c32cb0000000000000000000009184e72a000";
    }

    function getParams2() internal pure returns (bytes memory d, uint256 value) {
        value = 0.0e18;
        d =
            hex"8000ba1333333333a1ba1108e8412f11850a5c319ba90acc008004ba1333333333a1ba1108e8412f11850a5c319ba99895d81bb462a195b4922ed7de0e3acd007c32cbfca11d8c816f8e52f55d5d9858deee78f152d9030000000000000000000009184e72a00020fca11d8c816f8e52f55d5d9858deee78f152d9030000000000000000000000000000000008d540059895d81bb462a195b4922ed7de0e3acd007c32cb6131b5fae19ea4f9d964eac0408e4408b66337b5206131b5fae19ea4f9d964eac0408e4408b66337b5000000000000000000000000000000000884e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000005a000000000000000000000000000000000000000000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000009895d81bb462a195b4922ed7de0e3acd007c32cb000000000000000000000000a3d68b74bf0528fdd07263c60d6488749044914b0000000000000000000000008e24cfc19c6c00c524353cb8816f5f1c2f33c2010000000000000000000000000000000000000000000000000000000068d596b80000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000401823b2c30000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000a00000000000000000000000003c0441b42195f4ad6aa9a0978e06096ea616cda7000000000000000000000000000000000000000000000000000009184e72a0000000000000000000000000009895d81bb462a195b4922ed7de0e3acd007c32cb000000000000000000000000a3d68b74bf0528fdd07263c60d6488749044914b0000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec60000000000000000000000000000000000000000000000000000000000000020000000000000000000000000008d9fb700000000000000000000087102500d6e0000000000000000000000009895d81bb462a195b4922ed7de0e3acd007c32cb000000000000000000000000a3d68b74bf0528fdd07263c60d6488749044914b000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000002000000000000000000000000008e24cfc19c6c00c524353cb8816f5f1c2f33c201000000000000000000000000000000000000000000000000000009184e72a0000000000000000000000000000000000000000000000000000000085b66212c020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec60000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000009184e72a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000028a7b22536f75726365223a226e756c6c3a6c6f63616c686f7374222c22416d6f756e74496e555344223a22302e30333839323035333338313235333334222c22416d6f756e744f7574555344223a22302e303339333737343735373732333436323836222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a2239323831343633313237343035222c2254696d657374616d70223a313735383832373031362c22526f7574654944223a2232633935396632302d633831312d346135642d623765372d3435653636323930656264323a38613634303965642d373266312d343863322d623635302d373063313432636362386264222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a2244367377796b742f4b436a2f49684a69754a443271304665416b765557737a6c3442786e354e6e71437a757177644c44654953486e614766584339424e5a7454447a345176704762505550544d70396a4a42483850476b5051492b472b344c74647647377645363044423950656658744445505072366f47324367775a544a536d764f564579653763456c542f796a475a6f3737396f6567786a4b6444744877636b3064355851636635464e6b6d7a69367a684a2b34674a6c33754642756e72562f637545562f424242696a6b41353665534a4b4b6c68762f634a4e56305a4f585249733746545172364e526c784e745a39694b7963332f2b4453326a463549656c48704e736235323666596b544e4558624c34414278414b464e5a6b3653347a374a58545634367963306963794366753463302f557538685770594d4a5037314f696756674c6b5578767262636e714a4b2b3441673d3d227d7d000000000000000000000000000000000000000000004005a3d68b74bf0528fdd07263c60d6488749044914b925a2a7214ed92428b5b1b090f80b25700095e12300003e7a3d68b74bf0528fdd07263c60d6488749044914b00000000000000000000000000000000ed40933476462bdc6ddb042802cccd950d001bd6925a2a7214ed92428b5b1b090f80b25700095e125001638d7db63cd5c902bdd9a91cf195870551c3c7b300640000000000000000000000000000000000000000000000000002605dbc46eff868d59ec05fcb3c92614ec2e1bf538c67ae5151e307e84e95bfc02f1b08cc3ac26550fed8aad826974ec3c579c8a2227c1acc0b4e6489fb47c7b870b30f5c9a23a42abaaa300103e79895d81bb462a195b4922ed7de0e3acd007c32cb0000000000000000000009184e72a000ba1333333333a1ba1108e8412f11850a5c319ba902925a2a7214ed92428b5b1b090f80b25700095e128005ba1333333333a1ba1108e8412f11850a5c319ba99895d81bb462a195b4922ed7de0e3acd007c32cb0000000000000000000009184e72a000";
    }
}

// 0xb2f481d177fb61a2c8b8b27503d3f33b5596c6b7f1dd2246e8d14a6e49487bc2000000000000000000000000000000000000000000000000000000000000001c4e
// 0xb2f481d177fb61a2c8b8b27503d3f33b5596c6b7f1dd2246e8d14a6e49487bc2bfa8d508ba63b8f460adba12ced111eda5b0a53c9cabb6b052f3e5297586154e
// 0xb2f481d177fb61a2c8b8b27503d3f33b5596c6b7f1dd2246e8d14a6e49487bc23fa8d508ba63b8f460adba12ced111eda5b0a53c9cabb6b052f3e5297586154e1c
