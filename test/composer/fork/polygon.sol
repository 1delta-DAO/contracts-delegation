// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.19;

import {IERC20All} from "test/shared/interfaces/IERC20All.sol";
import {BaseTest} from "test/shared/BaseTest.sol";
import {Chains, Tokens, Lenders} from "test/data/LenderRegistry.sol";
import "test/composer/utils/CalldataLib.sol";
import {console} from "forge-std/console.sol";
import {ComposerPlugin, IComposerLike} from "plugins/ComposerPlugin.sol";

import "../../../contracts/external-protocols/misc/FeeOnTransferDetector.sol";
import "./FOT.sol";

// solhint-disable max-line-length

interface IA {
    function upgradeAndCall(address proxy, address implementation, bytes memory data) external;
}

contract ForkTestPolygon is BaseTest {
    IComposerLike oneDV2;

    address admin = 0xdAf4eA0785E33F710A186CA5330Bd26837f96765;
    address owner = 0x999999833d965c275A2C102a4Ebf222ca938546f;
    address proxy = 0xFd245e732b40b6BF2038e42b476bD06580585326;

    // address mockSender = 0x448CC254819520BF086BCf01245982fAB75c3F66;
    address mockSender = 0xdFF70A71618739f4b8C81B11254BcE855D02496B;

    uint256 internal constant forkBlock = 74234748;

    function setUp() public virtual {
        // initialize the chain
        string memory chainName = Chains.POLYGON_MAINNET;

        _init(chainName, forkBlock, true);

        oneDV2 = ComposerPlugin.getComposer(chainName);

        vm.prank(owner);
        IA(admin).upgradeAndCall(proxy, address(oneDV2), hex"");

        labelAddresses();
    }

    function labelAddresses() internal {
        vm.label(owner, "owner");
        vm.label(admin, "admin");
        vm.label(proxy, "proxy");
        vm.label(address(oneDV2), "Composer");
        vm.label(mockSender, "MeMeMeMe");
    }

    function test_fork_raw_polygon_swap() external {
        vm.prank(mockSender);
        address(proxy).call(getData());
    }

    function test_fork_params_polygon() external {
        vm.prank(mockSender);
        (bytes memory params, uint256 value) = getParams2();
        IComposerLike(proxy).deltaCompose{value: value}(params);
    }

    // nonce 0n
    // cometCreditPermit.ts:120 expiry 1748970849
    // cometCreditPermit.ts:121 v,r,s 27n 0x8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f 0x16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab
    // cometCreditPermit.ts:126 r 8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f
    // cometCreditPermit.ts:127 vs 16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab

    function getData() internal pure returns (bytes memory d) {
        d =
            hex"17d73091000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003ca400503b54a6e9a984069379fae1a4fc4dbae93b3bccd1bf0c2541f820e775182832f06c0b7fc27a25f67600003b54a6e9a984069379fae1a4fc4dbae93b3bccd1bf0c2541f820e775182832f06c0b7fc27a25f670000000000000000000a739201b9fab2032900400103b54a6e9a984069379fae1a4fc4dbae93b3bccdfca1154c643c32638aee9a43eee7f377f515c801010000000000000000000a739201b9fab220fca1154c643c32638aee9a43eee7f377f515c801000000000000000000000000000000000127400503b54a6e9a984069379fae1a4fc4dbae93b3bccd4e3288c9ca110bcc82bf38f09a7b425c095d92bf204e3288c9ca110bcc82bf38f09a7b425c095d92bf0000000000000000000000000000000000d683bd37f9000103b54a6e9a984069379fae1a4fc4dbae93b3bccd00017ceb23fd6bc0add59e62ac25578270cff1b9f619070a739201b9fab2070c99e80b5d345b028f5c0001ECDfcB1dD81d07c3551CbA94023EE443450353E100000001Fd245e732b40b6BF2038e42b476bD065805853260000000003010203000f0101010201ff000000000000000000000000000000000000000000370404a2a57edfbeaf16dc8ef8e2d1b0a2a9da1503b54a6e9a984069379fae1a4fc4dbae93b3bccd00000000000000000000000000000000000000000000000040057ceb23fd6bc0add59e62ac25578270cff1b9f6191bf0c2541f820e775182832f06c0b7fc27a25f67300213877ceb23fd6bc0add59e62ac25578270cff1b9f61903b54a6e9a984069379fae1a4fc4dbae93b3bccd1dc2444b54945064c131145cd6b8701e3454c63ae675a2161d4a6e2de2eed70ac98eebf257fbf0b000000000000000000cb2bba6f17b80000000ffffffffffffffffffffffffffffdff70a71618739f4b8c81b11254bce855d02496b1bf0c2541f820e775182832f06c0b7fc27a25f670000300313887ceb23fd6bc0add59e62ac25578270cff1b9f61903b54a6e9a984069379fae1a4fc4dbae93b3bccd1dc2444b54945064c131145cd6b8701e3454c63ae675a2161d4a6e2de2eed70ac98eebf257fbf0b000000000000000000cb2bba6f17b80000000000000000000000a739201b9fab2fd245e732b40b6bf2038e42b476bd065805853261bf0c2541f820e775182832f06c0b7fc27a25f6740017ceb23fd6bc0add59e62ac25578270cff1b9f619dff70a71618739f4b8c81b11254bce855d02496b000000000000000000000000000000000040017ceb23fd6bc0add59e62ac25578270cff1b9f619dff70a71618739f4b8c81b11254bce855d02496b000000000000000000000000000000000000000000000000000000000000000000000000000000";
    }

    function getParams2() internal pure returns (bytes memory d, uint256 value) {
        value = 0;
        d =
            hex"1000000000000000000000086954db3b6b000000000000000000000000000000017ceb23fd6bc0add59e62ac25578270cff1b9f61900000d500b1d8e8ef31e21c99d1db9a6444d3adf1270fd245e732b40b6bf2038e42b476bd06580585326001a34eabbe928bf431b679959379b2225d60d9cda0d01f406ca1000000000000000000000000000000000000000000000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000d6df932a45c0f255f85145f286ea0b292b21c90bfd245e732b40b6bf2038e42b476bd0658058532600b3866eb993e1aef93f219c3da0a71c3f11becbf20001f40001100000000000000000000010d2a9b676d7000000000000000000000000000000017ceb23fd6bc0add59e62ac25578270cff1b9f61900000d500b1d8e8ef31e21c99d1db9a6444d3adf1270fd245e732b40b6bf2038e42b476bd0658058532600479e1b71a702a595e19b6d5932cd5c863ab57ee0006bb905d81000000000000000000000000000000000000000000000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf1270010000008f3cf7ad23cd3cadbd9735aff958023239c6a063fd245e732b40b6bf2038e42b476bd06580585326000f663c16dd7c65cf87edb9229464ca77aeea536b0001f400010000d6df932a45c0f255f85145f286ea0b292b21c90bfd245e732b40b6bf2038e42b476bd0658058532600d20f057b05f1d62c1fe306f6ee77ab4c8fd7e2fb000bb80001100000000000000000000010d2a9b676d7000000000000000000000000000000017ceb23fd6bc0add59e62ac25578270cff1b9f61900000d500b1d8e8ef31e21c99d1db9a6444d3adf1270fd245e732b40b6bf2038e42b476bd065805853260086f1d8390222a3691c28938ec7404a1661e618e00001f404a01000000000000000000000000000000000000000000000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000d6df932a45c0f255f85145f286ea0b292b21c90bfd245e732b40b6bf2038e42b476bd0658058532601b2bb7c1c176ba8f2ef4230e28175b841e60ef69226f20000011000000000000000000000193bfe91b242000000000000000000000000000000017ceb23fd6bc0add59e62ac25578270cff1b9f61900000d500b1d8e8ef31e21c99d1db9a6444d3adf1270fd245e732b40b6bf2038e42b476bd065805853260162fc1e1fdabc0c9f2b096019e2d98204da049457270b8603ae1000000000000000000000000000000000000000000000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000d6df932a45c0f255f85145f286ea0b292b21c90bfd245e732b40b6bf2038e42b476bd065805853260142ed6d85ccf43859cbc46f6efa1f21e21cc2403026fc0c0001100000000000000000000064effa46c90a000000000000000000000000000000007ceb23fd6bc0add59e62ac25578270cff1b9f6190000d6df932a45c0f255f85145f286ea0b292b21c90bfd245e732b40b6bf2038e42b476bd065805853260025fb97799f80433e422f47e75173314e54dae1740001f402bc4005d6df932a45c0f255f85145f286ea0b292b21c90b794a61358d6845594f94dc1db02a252b5b4814ad300003e7d6df932a45c0f255f85145f286ea0b292b21c90b00000000000000000000000000000000448cc254819520bf086bcf01245982fab75c3f66794a61358d6845594f94dc1db02a252b5b4814ad5000e50fa9b3c56ffb159cb0fca61f5c9d750e8128c800640000000000000000000000000000000000000000000000000000a865b22f44506850767516b30f31b315be0973d988b16cc43cf0998b859fa165bc5e2a157e5161a23a7d46dc09895f33a6b48339352e92a1574153aba698173ad7ea86c538c6368c75d7300303e77ceb23fd6bc0add59e62ac25578270cff1b9f6190000fffffffffffffffffffffffffffffd245e732b40b6bf2038e42b476bd06580585326e50fa9b3c56ffb159cb0fca61f5c9d750e8128c8794a61358d6845594f94dc1db02a252b5b4814ad40017ceb23fd6bc0add59e62ac25578270cff1b9f61925fb97799f80433e422f47e75173314e54dae174010000000000000000000064effa46c90a40017ceb23fd6bc0add59e62ac25578270cff1b9f61962fc1e1fdabc0c9f2b096019e2d98204da0494570100000000000000000000193bfe91b24240017ceb23fd6bc0add59e62ac25578270cff1b9f61986f1d8390222a3691c28938ec7404a1661e618e0010000000000000000000010d2a9b676d740017ceb23fd6bc0add59e62ac25578270cff1b9f619479e1b71a702a595e19b6d5932cd5c863ab57ee0010000000000000000000010d2a9b676d740017ceb23fd6bc0add59e62ac25578270cff1b9f6191a34eabbe928bf431b679959379b2225d60d9cda0100000000000000000000086954db3b6b40017ceb23fd6bc0add59e62ac25578270cff1b9f619448cc254819520bf086bcf01245982fab75c3f660000000000000000000000000000000000";
    }
}
