// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.19;

import {IERC20All} from "test/shared/interfaces/IERC20All.sol";
import {BaseTest} from "test/shared/BaseTest.sol";
import {Chains, Tokens, Lenders} from "test/data/LenderRegistry.sol";
import "test/composer/utils/CalldataLib.sol";
// solhint-disable no-console
import {console} from "forge-std/console.sol";
import {ComposerPlugin, IComposerLike} from "plugins/ComposerPlugin.sol";

import "../../../contracts/external-protocols/misc/FeeOnTransferDetector.sol";
import "./FOT.sol";

// solhint-disable max-line-length

interface IA {
    function upgradeAndCall(address proxy, address implementation, bytes memory data) external;
}

contract ForkTestAvalanche is BaseTest {
    IComposerLike oneDV2;

    address admin = 0xBb7EAaAF2C7208384F6297C2b73935D257698c78;
    address owner = 0x999999833d965c275A2C102a4Ebf222ca938546f;
    address proxy = 0x8E24CfC19c6C00c524353CB8816f5f1c2F33c201;

    // address mockSender = 0x448CC254819520BF086BCf01245982fAB75c3F66;
    address mockSender = 0x973dcE02772Ec64B4b018425535E4fF98e27b6bD;

    uint256 internal constant forkBlock = 66000800;

    function setUp() public virtual {
        // initialize the chain
        string memory chainName = Chains.AVALANCHE_C_CHAIN;

        _init(chainName, forkBlock, true);

        oneDV2 = ComposerPlugin.getComposer(chainName);

        vm.prank(owner);
        IA(admin).upgradeAndCall(proxy, address(oneDV2), hex"");

        labelAddresses();
    }

    function labelAddresses() internal {
        vm.label(owner, "owner");
        vm.label(admin, "admin");
        vm.label(proxy, "proxy");
        vm.label(address(oneDV2), "Composer");
        vm.label(mockSender, "MeMeMeMe");
    }

    function test_fork_raw_avalanche_swap() external {
        vm.prank(mockSender);
        address(proxy).call(getData());
    }

    function test_fork_params_avalanche() external {
        vm.prank(mockSender);
        (bytes memory params, uint256 value) = getParams2();
        IComposerLike(proxy).deltaCompose{value: value}(params);
    }

    // nonce 0n
    // cometCreditPermit.ts:120 expiry 1748970849
    // cometCreditPermit.ts:121 v,r,s 27n 0x8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f 0x16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab
    // cometCreditPermit.ts:126 r 8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f
    // cometCreditPermit.ts:127 vs 16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab

    function getData() internal pure returns (bytes memory d) {
        d =
            hex"17d7309100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000c848000ba1333333333a1ba1108e8412f11850a5c319ba90c6c008004ba1333333333a1ba1108e8412f11850a5c319ba9b97ef9ef8734c71904d8002f8b6bc66dd9c48a6efca1154c643c32638aee9a43eee7f377f515c80100000000000000000000000056124d4020fca1154c643c32638aee9a43eee7f377f515c801000000000000000000000000000000000a754005b97ef9ef8734c71904d8002f8b6bc66dd9c48a6e6131b5fae19ea4f9d964eac0408e4408b66337b5206131b5fae19ea4f9d964eac0408e4408b66337b5000000000000000000000000000000000a24e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000007400000000000000000000000000000000000000000000000000000000000000440000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000b97ef9ef8734c71904d8002f8b6bc66dd9c48a6e00000000000000000000000049d5c2bdffac6ce2bfdb6640f4f80f226bc10bab0000000000000000000000008e24cfc19c6c00c524353cb8816f5f1c2f33c20100000000000000000000000000000000000000000000000000000000688248af00000000000000000000000000000000000000000000000000000000000003e000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000004048d318020000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e00000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec600000000000000000000000041100c6d2c6920b10d12cd8d59c8a9aa2ef56fc7000000000000000000000000b97ef9ef8734c71904d8002f8b6bc66dd9c48a6e000000000000000000000000b31f66aa3c1e785363f0875a1b74e27b85fd66c70000000000000000000000000000000000000000000000000000000056124d40000000000000000000000000ff120d460d67f1db5b71087bd404babb342b59870000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004048d318020000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e00000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec60000000000000000000000005e128ebc09c918ddae3ca1668d4ee9527dc00d78000000000000000000000000b31f66aa3c1e785363f0875a1b74e27b85fd66c700000000000000000000000049d5c2bdffac6ce2bfdb6640f4f80f226bc10bab00000000000000000000000000000000000000000000000349d3e03d528457c8000000000000000000000000ff120d460d67f1db5b71087bd404babb342b59870000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000005bbc63cc1a00000000000000000577c759c917cd10000000000000000000000000b97ef9ef8734c71904d8002f8b6bc66dd9c48a6e00000000000000000000000049d5c2bdffac6ce2bfdb6640f4f80f226bc10bab000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000002000000000000000000000000008e24cfc19c6c00c524353cb8816f5f1c2f33c2010000000000000000000000000000000000000000000000000000000056124d40000000000000000000000000000000000000000000000000056f614a66182b930000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000006e4141d33021b52c91c28608403db4a0ffb50ec600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000056124d4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002947b22536f75726365223a226e756c6c3a73746167696e672e3164656c74612e696f222c22416d6f756e74496e555344223a22313433362e343634353237383935353439222c22416d6f756e744f7574555344223a22313433362e34353539303333353638363535222c22526566657272616c223a22222c22466c616773223a302c22416d6f756e744f7574223a22333934303032363830383538303034373532222c2254696d657374616d70223a313735333336373535312c22526f7574654944223a2230633662666638352d383162662d343237612d623765382d6337383761636130623636343a31346434383534352d393366612d343865312d383561642d623638373536353963663932222c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a224e42306f696c324f4c374676686265365665786457375277647a55424f3934422f6167695a5277516b4e3861686176594158714f6139467353354e464332466246354f7671417633554373314e4f36704249657259774a7657775558795973626775394c7137585837446b2b75516168576d7a52617941524c5037495063533947706a5a31754557526274695559666a6d5965394c5a475841583937744978746c43586743526e57484d347330315944622f774c30577968745a4233612b3570322b7664664b4e63747674744f494758743546486c78455968756755456a2b57505234724479534b666968594c4e4e72784330774531346b7673462f7352616e794a544e62524441386c716e747137324e2b5676743568336833427641366c6b386a6f7977596f48315679685446753446446a6e724245736f65717034736976614b3153396e416665674373786c505356576e626e413d3d227d7d000000000000000000000000400549d5c2bdffac6ce2bfdb6640f4f80f226bc10bab794a61358d6845594f94dc1db02a252b5b4814ad300003e749d5c2bdffac6ce2bfdb6640f4f80f226bc10bab00000000000000000000000000000000973dce02772ec64b4b018425535e4ff98e27b6bd794a61358d6845594f94dc1db02a252b5b4814ad5001fccf3cabbe80101232d343252614b6a3ee81c9890064000000000000000000000000000000000000000000000000000000005628560968825174d60c4eb91a167886a629def82ba744e90644b73db96da9c13e86eaa5de89ad65d89b393b06ac41ba1e3701c6778774923425c3ce34764a1c51e3fcc276e6843d300103e7b97ef9ef8734c71904d8002f8b6bc66dd9c48a6e00000000000000000000000056124d40ba1333333333a1ba1108e8412f11850a5c319ba902794a61358d6845594f94dc1db02a252b5b4814ad8005ba1333333333a1ba1108e8412f11850a5c319ba9b97ef9ef8734c71904d8002f8b6bc66dd9c48a6e00000000000000000000000056124d4000000000000000000000000000000000000000000000000000000000";
    }

    function getParams2() internal pure returns (bytes memory d, uint256 value) {
        value = 0;
        d =
            hex"1000000000000000000000086954db3b6b000000000000000000000000000000017ceb23fd6bc0add59e62ac25578270cff1b9f61900000d500b1d8e8ef31e21c99d1db9a6444d3adf1270fd245e732b40b6bf2038e42b476bd06580585326001a34eabbe928bf431b679959379b2225d60d9cda0d01f406ca1000000000000000000000000000000000000000000000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000d6df932a45c0f255f85145f286ea0b292b21c90bfd245e732b40b6bf2038e42b476bd0658058532600b3866eb993e1aef93f219c3da0a71c3f11becbf20001f40001100000000000000000000010d2a9b676d7000000000000000000000000000000017ceb23fd6bc0add59e62ac25578270cff1b9f61900000d500b1d8e8ef31e21c99d1db9a6444d3adf1270fd245e732b40b6bf2038e42b476bd0658058532600479e1b71a702a595e19b6d5932cd5c863ab57ee0006bb905d81000000000000000000000000000000000000000000000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf1270010000008f3cf7ad23cd3cadbd9735aff958023239c6a063fd245e732b40b6bf2038e42b476bd06580585326000f663c16dd7c65cf87edb9229464ca77aeea536b0001f400010000d6df932a45c0f255f85145f286ea0b292b21c90bfd245e732b40b6bf2038e42b476bd0658058532600d20f057b05f1d62c1fe306f6ee77ab4c8fd7e2fb000bb80001100000000000000000000010d2a9b676d7000000000000000000000000000000017ceb23fd6bc0add59e62ac25578270cff1b9f61900000d500b1d8e8ef31e21c99d1db9a6444d3adf1270fd245e732b40b6bf2038e42b476bd065805853260086f1d8390222a3691c28938ec7404a1661e618e00001f404a01000000000000000000000000000000000000000000000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000d6df932a45c0f255f85145f286ea0b292b21c90bfd245e732b40b6bf2038e42b476bd0658058532601b2bb7c1c176ba8f2ef4230e28175b841e60ef69226f20000011000000000000000000000193bfe91b242000000000000000000000000000000017ceb23fd6bc0add59e62ac25578270cff1b9f61900000d500b1d8e8ef31e21c99d1db9a6444d3adf1270fd245e732b40b6bf2038e42b476bd065805853260162fc1e1fdabc0c9f2b096019e2d98204da049457270b8603ae1000000000000000000000000000000000000000000000000000000000000000000d500b1d8e8ef31e21c99d1db9a6444d3adf12700000d6df932a45c0f255f85145f286ea0b292b21c90bfd245e732b40b6bf2038e42b476bd065805853260142ed6d85ccf43859cbc46f6efa1f21e21cc2403026fc0c0001100000000000000000000064effa46c90a000000000000000000000000000000007ceb23fd6bc0add59e62ac25578270cff1b9f6190000d6df932a45c0f255f85145f286ea0b292b21c90bfd245e732b40b6bf2038e42b476bd065805853260025fb97799f80433e422f47e75173314e54dae1740001f402bc4005d6df932a45c0f255f85145f286ea0b292b21c90b794a61358d6845594f94dc1db02a252b5b4814ad300003e7d6df932a45c0f255f85145f286ea0b292b21c90b00000000000000000000000000000000448cc254819520bf086bcf01245982fab75c3f66794a61358d6845594f94dc1db02a252b5b4814ad5000e50fa9b3c56ffb159cb0fca61f5c9d750e8128c800640000000000000000000000000000000000000000000000000000a865b22f44506850767516b30f31b315be0973d988b16cc43cf0998b859fa165bc5e2a157e5161a23a7d46dc09895f33a6b48339352e92a1574153aba698173ad7ea86c538c6368c75d7300303e77ceb23fd6bc0add59e62ac25578270cff1b9f6190000fffffffffffffffffffffffffffffd245e732b40b6bf2038e42b476bd06580585326e50fa9b3c56ffb159cb0fca61f5c9d750e8128c8794a61358d6845594f94dc1db02a252b5b4814ad40017ceb23fd6bc0add59e62ac25578270cff1b9f61925fb97799f80433e422f47e75173314e54dae174010000000000000000000064effa46c90a40017ceb23fd6bc0add59e62ac25578270cff1b9f61962fc1e1fdabc0c9f2b096019e2d98204da0494570100000000000000000000193bfe91b24240017ceb23fd6bc0add59e62ac25578270cff1b9f61986f1d8390222a3691c28938ec7404a1661e618e0010000000000000000000010d2a9b676d740017ceb23fd6bc0add59e62ac25578270cff1b9f619479e1b71a702a595e19b6d5932cd5c863ab57ee0010000000000000000000010d2a9b676d740017ceb23fd6bc0add59e62ac25578270cff1b9f6191a34eabbe928bf431b679959379b2225d60d9cda0100000000000000000000086954db3b6b40017ceb23fd6bc0add59e62ac25578270cff1b9f619448cc254819520bf086bcf01245982fab75c3f660000000000000000000000000000000000";
    }
}
