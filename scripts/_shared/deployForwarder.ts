import {ethers} from "hardhat";
import {CallForwarder__factory, DeployFactory__factory} from "../../types";
import {DEPLOY_FACTORY} from "./addresses";
import {keccak256} from "ethers/lib/utils";

/**
export FACTORY="0x16c4Dc0f662E2bEceC91fC5E7aeeC6a25684698A"
export CALLER="0x16c4Dc0f662E2bEceC91fC5E7aeeC6a25684698A"
export INIT_CODE_HASH="0xdd5553b31c840787634b5cb5fd28ce3df3d4bb7254b9843bbffb2aca57a93cdc"
export GPU_DEVICE=255
export ADDRESS_START_WITH="fca11"
export ADDRESS_END_WITH="06"
cargo run --release $FACTORY $CALLER $INIT_CODE_HASH $GPU_DEVICE $ADDRESS_START_WITH $ADDRESS_END_WITH
 */

// 0x16c4dc0f662e2becec91fc5e7aeec6a25684698a8d13667fe6f81100607ba219 => 0xfCa11b85ac641f1ba215259566d579A45519e506 (1 / 0)

async function main() {
    const accounts = await ethers.getSigners();
    const operator = accounts[1];
    const chainId = await operator.getChainId();
    console.log("operator", operator.address, "on", chainId);

    const gp = await operator.getGasPrice();

    console.log("gasPrice", gp.toNumber() / 1e9);

    console.log("Get deploy factory");

    const salt = "0x16c4dc0f662e2becec91fc5e7aeec6a25684698a8d13667fe6f81100607ba219";
    //  deploys to 0xfCa11b85ac641f1ba215259566d579A45519e506
    const bytecode =
        "0x6080604052348015600f57600080fd5b506119948061001f6000396000f3fe6080604052600436106100225760003560e01c80636a0c90ff1461002e57600080fd5b3661002957005b600080fd5b61004161003c3660046118b0565b610043565b005b604460243581013361005681848461005d565b5050505050565b60018201913560f81c60408110156100c957602081036100875761008083610146565b92506100f4565b60218103610099576100808385610277565b602281036100aa5761008083610412565b602381036100bc5761008083856105d2565b6100c46107cf565b6100f4565b604081036100db5761008083856107f9565b609081036100ec5761008083610870565b6100f46107cf565b8183106101015750610107565b5061005d565b80821115610141576040517f8129bbcd00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b505050565b6000813560601c6e22d473030f116ddee9f6b43ac78ba3810361018d577fee90c4680000000000000000000000000000000000000000000000000000000060005260046000fd5b6026830192601481013560801c906024013560f01c6f80000000000000000000000000000000821680156101c3574792506101d8565b6effffffffffffffffffffffffffffff831692505b506040517f23b872dd0000000000000000000000000000000000000000000000000000000086357fffffffff000000000000000000000000000000000000000000000000000000001603610250577fee90c4680000000000000000000000000000000000000000000000000000000060005260046000fd5b81868237600080838386885af161026b573d6000803e3d6000fd5b50939093019392505050565b600080600080853560601c6e22d473030f116ddee9f6b43ac78ba381036102c2577fee90c4680000000000000000000000000000000000000000000000000000000060005260046000fd5b6026870196601481013560801c906024013560f01c6f80000000000000000000000000000000821680156102f85747925061030d565b6effffffffffffffffffffffffffffff831692505b506040517f23b872dd000000000000000000000000000000000000000000000000000000008a357fffffffff000000000000000000000000000000000000000000000000000000001603610385577fee90c4680000000000000000000000000000000000000000000000000000000060005260046000fd5b818a8237600080838386885af1965050808901985050505085358060f81c92508315831516156103b9573d6000803e3d6000fd5b8060e81c61ffff16915050600386019550826104005780156103f15760006103e18288611924565b90506103ee86888361005d565b95505b816001036103fb57005b610405565b948501945b8593505050505b92915050565b6000813560601c6e22d473030f116ddee9f6b43ac78ba38103610459577fee90c4680000000000000000000000000000000000000000000000000000000060005260046000fd5b603c830192601481013560801c90602490810135606081901c9161ffff605083901c81169260401c169082018110156104b6577f5395d8540000000000000000000000000000000000000000000000000000000060005260046000fd5b6f80000000000000000000000000000000841680156104d7574794506104ec565b6effffffffffffffffffffffffffffff851694505b50604051818882378315610539577f70a0823100000000000000000000000000000000000000000000000000000000600052306004526020600060246000875afa50600051836004830101525b7f23b872dd0000000000000000000000000000000000000000000000000000000081517fffffffff0000000000000000000000000000000000000000000000000000000016036105ad577fee90c4680000000000000000000000000000000000000000000000000000000060005260046000fd5b6000808383888a5af16105c4573d6000803e3d6000fd5b509590950195945050505050565b600080600080853560601c6e22d473030f116ddee9f6b43ac78ba3810361061d577fee90c4680000000000000000000000000000000000000000000000000000000060005260046000fd5b866014019650863560801c87601001975087358060501c61ffff168160401c61ffff168260381c60ff1696508260281c61ffff1695508260601c92508a601b019a5080600460208401011115610697577f5395d8540000000000000000000000000000000000000000000000000000000060005260046000fd5b6f80000000000000000000000000000000841680156106b8574794506106cd565b6effffffffffffffffffffffffffffff851694505b50604051818c8237831561071a577f70a0823100000000000000000000000000000000000000000000000000000000600052306004526020600060246000875afa50600051836004830101525b7f23b872dd0000000000000000000000000000000000000000000000000000000081517fffffffff00000000000000000000000000000000000000000000000000000000160361078e577fee90c4680000000000000000000000000000000000000000000000000000000060005260046000fd5b6000808383888a5af19850508715871516156107ae573d6000803e3d6000fd5b808b019a505050505050826104005780156103f15760006103e18288611924565b7f398d4d320000000000000000000000000000000000000000000000000000000060005260046000fd5b60018201916000903560f81c8061081c5761081484846108d2565b91505061040c565b6001810361082d576108148461099c565b6003810361083e5761081484610b51565b60048103610850576108148484610cb2565b600581036108615761081484610d6d565b6108696107cf565b5092915050565b60018101906000903560f81c806108915761088a83610e2d565b9392505050565b600a81036108a25761088a8361117f565b601481036108b35761088a8361151d565b601e81036108c45761088a83611546565b6108cc6107cf565b50919050565b6000823560601c601484013560601c602885013560801c80610927577f70a0823100000000000000000000000000000000000000000000000000000000600052846004526020600060246000865afa50506000515b6040517f23b872dd0000000000000000000000000000000000000000000000000000000081528560048201528260248201528160448201526020816064836000885af193503d92506001815114601f841116831517841661098c57826000803e826000fd5b5050506038939093019392505050565b6000813560601c601483013560601c60198401358060801c60ff16816fffffffffffffffffffffffffffffffff1691506000841560008114610a60578280156109e757849250610a1c565b47925084831015610a1c577f7dd37f700000000000000000000000000000000000000000000000000000000060005260046000fd5b508115610a5b5760008060008085895af1610a5b577ff4b3b1bc0000000000000000000000000000000000000000000000000000000060005260046000fd5b610b40565b828015610a6f57849250610ada565b7f70a08231000000000000000000000000000000000000000000000000000000006000523060045260206000602460008a5afa50600051925084831015610ada577f7dd37f700000000000000000000000000000000000000000000000000000000060005260046000fd5b508115610b40576040517fa9059cbb00000000000000000000000000000000000000000000000000000000815285600482015282602482015260208160448360008b5af13d6001835114601f8211168115178216610b3c57806000803e806000fd5b5050505b505050603994909401949350505050565b60008135606090811c906014840135901c60198401356effffffffffffffffffffffffffffff81169060801c60ff1684818015610b9057839150610bfb565b7f70a0823100000000000000000000000000000000000000000000000000000000600052306004526020600060246000895afa50600051915083821015610bfb577f7dd37f700000000000000000000000000000000000000000000000000000000060005260046000fd5b508015610ca2577f2e1a7d4d00000000000000000000000000000000000000000000000000000000600052806004526000806024600080895af1610c63577ff4b3b1bc0000000000000000000000000000000000000000000000000000000060005260046000fd5b308414610ca25760008060008084885af1610ca2577ff4b3b1bc0000000000000000000000000000000000000000000000000000000060005260046000fd5b5050506039939093019392505050565b6000823560601c601484013560601c602885013560801c80610d07577f70a0823100000000000000000000000000000000000000000000000000000000600052846004526020600060246000865afa50506000515b6040517f36c7851600000000000000000000000000000000000000000000000000000000815285600482015282602482015281604482015283606482015260008060848360006e22d473030f116ddee9f6b43ac78ba35af161098c573d6000803e3d6000fd5b6000813560601c601483013560601c816000527f1aae13105d9b6581c36534caba5708726e5ea1e03175e823c989a5756966d1f360205260406000206020528060005260406000208054610e1f576040517f095ea7b30000000000000000000000000000000000000000000000000000000081528260048201527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff60248201526020816044836000885af15050600181555b505050602891909101919050565b6000610e79565b8060005260046000fd5b7f70a0823100000000000000000000000000000000000000000000000000000000600052306004526020600060246000845afa505060005190565b8135606090811c90608584013560f090811c91608786013590911c90850135608090811c7fffffffffffffffffffffffffffffffff7fffffffffffffffffffffffffffffff811691600091607489013590911c9082906f800000000000000000000000000000001647851560018114610f3857828015610efd578588019650610f01565b8596505b5081861115610f3357610f337f1101129400000000000000000000000000000000000000000000000000000000610e34565b610f8d565b828015610f4c578583039750829650610f8b565b610f558b610e3e565b975085965082871115610f8b57610f8b7f1101129400000000000000000000000000000000000000000000000000000000610e34565b505b505050633b9aca0060708a013560e01c633b9aca0003850204905060405196507fcbef2aa90000000000000000000000000000000000000000000000000000000087526080600488015281602488015260006044880152604c89013560601c6064880152602889013560e01c6084880152602c89013560a48801528360c48801528060e4880152505060e06101048601526000915082156001811461103757801561104157611076565b6101209250611076565b602084046020850660008082116001811461105e57839150611065565b6001840191505b506001810160200260e00195505050505b508161012486015260008415600181146110c25760208604602087066000808211600181146110a7578391506110ae565b6001840191505b5060018101602002870194505050506110c9565b6020840191505b506101448601819052610164860184815284156110ed57848660898b010160208301375b5091850160840184815291841561110957846089890160208501375b60009250850160849081019088013560f81c156001811461113c5760208252600060208301528660408301039350611149565b6000825286602083010393505b505081850160405260008083878460148c013560601c5af161116f573d6000803e3d6000fd5b5050930190920160890192915050565b6000602882013560601c605c83013560801c7fffffffffffffffffffffffffffffffff7fffffffffffffffffffffffffffffff8116906f800000000000000000000000000000001660aa85013560f01c8483156001811461121b5783156112165747851115611212577f110112940000000000000000000000000000000000000000000000000000000060005260046000fd5b8491505b611269565b83801561122d57479550859250611267565b7f70a08231000000000000000000000000000000000000000000000000000000006000523060045260206000602460008a5afa5060005195505b505b50606c87013560801c9250828411600181146112a9577f5945ea560000000000000000000000000000000000000000000000000000000060005260046000fd5b9284039250608487013560f881901c9060f01c60ff16818103600060018484146113835760ff83901d8084180380600c811461132f57600b811461133c57600a811461134957600981146113565760088114611362576007811461136e57600681146113795760005b8281101561132957600a9390930292600101611312565b50611380565b64e8d4a510009250611380565b64174876e8009250611380565b6402540be4009250611380565b633b9aca009250611380565b6305f5e1009250611380565b629896809250611380565b620f424092505b50505b848410600181146113ab5797810297633b9aca00607c8e013560e01c8b0283020492506113c5565b81633b9aca0002607c8e013560e01c8b0204925081890498505b5050808711600181146113fc577f5945ea560000000000000000000000000000000000000000000000000000000060005260046000fd5b908703905060405196507fad5425c600000000000000000000000000000000000000000000000000000000875260148b013560601c600488015260868b01356024880152886044880152603c8b013560648801528760848801528060a488015250505050608087013560e01c60c4840152600060e48401524261010484015260a687013560e01c61012484015260006101448401526101806101648401528161018484015260008211600181146114d7576000806101a486858c3560601c5af16114ca573d6000803e3d6000fd5b6101a4840160405261150c565b8260ac89016101a4860137600080846101a40186858c3560601c5af1611501573d6000803e3d6000fd5b826101c40184016040525b50509490940160ac01949350505050565b60288101906000908035606090811c9160140135901c61153e828286611654565b949350505050565b6000813560601c6014830135603484013560801c60448501356064860195508115600181036115a057479250826115a0576115a07f669567ea00000000000000000000000000000000000000000000000000000000610e34565b504681036115d1576115d17fac6b05f500000000000000000000000000000000000000000000000000000000610e34565b826115ff576115ff7f1e4ec46b00000000000000000000000000000000000000000000000000000000610e34565b6040517fc9630cb000000000000000000000000000000000000000000000000000000000815281600482015283602482015260008060448386895af1611649573d6000803e3d6000fd5b509495945050505050565b6000604051905081358060f01c8160101b60f01c8260201b60f01c8360301b60f01c8460401b60801c9450601887013560801c478111156116b9577f110112940000000000000000000000000000000000000000000000000000000060005260046000fd5b60288801358060581c60ff168160601c915087600081146116df578860808b015261171c565b7f70a08231000000000000000000000000000000000000000000000000000000006000523060045260206000602460008f5afa5060005160808b01525b5086895260208901869052604089018590526060890184905260a089019290925260c0880181905260e08089018390527f2147796000000000000000000000000000000000000000000000000000000000610100808b01919091526101048a0182815260808b01516101248c0152601f9889017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe09081169283016101448d01819052988a0181169092016101208101610164808e01829052988b018416808301610140016101848f018190526101a48f01979097526101c48e0197909752603d9d909d019c939a509798929793969290950116909201010190611838565b60008382018351808252808760208401379590950195945050505050565b6118448887898461181a565b9750611855888660208a018461181a565b9750611866888560408a018461181a565b9750611877888460608a018461181a565b9750508061010087010160405260008082610100890160a08a01518d5af16118a3573d6000803e3d6000fd5b5094979650505050505050565b600080602083850312156118c357600080fd5b823567ffffffffffffffff8111156118da57600080fd5b8301601f810185136118eb57600080fd5b803567ffffffffffffffff81111561190257600080fd5b85602082840101111561191457600080fd5b6020919091019590945092505050565b8082018082111561040c577f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fdfea2646970667358221220fde2a8e6360e8c11e68c5f2438c8fd068574f52949537bb724e367149cce2f7e64736f6c634300081c0033";

    const initCode = keccak256(bytecode);
    console.log("initCode", initCode); // 0x6d95759de5f9c1ff23720012281168c1b9cdc928be6790a9eb2efdc32bad0980 (paris, 1m steps)

    const deployFactory = await new DeployFactory__factory(operator).attach(DEPLOY_FACTORY);
    const address = await deployFactory.computeAddress(salt, initCode);
    // console.log("address", address);
    const estimate = await deployFactory.estimateGas.deploy(salt, bytecode);
    console.log("estimate", estimate);
    const tx = await deployFactory.deploy(salt, bytecode, {gasLimit: estimate.add(100), gasPrice: gp.mul(100)});
    await tx.wait();

    console.log("deployed expected to", address);
}

main()
    .then(() => process.exit(0))
    .catch((error) => {
        console.error(error);
        process.exit(1);
    });
