// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.19;

import {IERC20All} from "test/shared/interfaces/IERC20All.sol";
import {BaseTest} from "test/shared/BaseTest.sol";
import {Chains, Tokens, Lenders} from "test/data/LenderRegistry.sol";
import "contracts/utils/CalldataLib.sol";
// solhint-disable no-console
import {console} from "forge-std/console.sol";
import {ComposerPlugin, IComposerLike} from "plugins/ComposerPlugin.sol";

import "../../../contracts/external-protocols/misc/FeeOnTransferDetector.sol";

// solhint-disable max-line-length

interface IA {
    function upgradeAndCall(address proxy, address implementation, bytes memory data) external;
}

contract ForkTestBnb is BaseTest {
    IComposerLike oneDV2;

    address admin = 0xb63E6455858887C8F6bda75C44c41570be989597;
    address owner = 0x999999833d965c275A2C102a4Ebf222ca938546f;
    address proxy = 0x816EBC5cb8A5651C902Cb06659907A93E574Db0B;

    address mockSender = 0xbadA9c382165b31419F4CC0eDf0Fa84f80A3C8E5;
    // address mockSender = 0xdFF70A71618739f4b8C81B11254BcE855D02496B;

    uint256 internal constant forkBlock = 0;

    function setUp() public virtual {
        // initialize the chain
        string memory chainName = Chains.BNB_SMART_CHAIN_MAINNET;

        _init(chainName, forkBlock, true);

        oneDV2 = ComposerPlugin.getComposer(chainName);

        vm.prank(owner);
        IA(admin).upgradeAndCall(proxy, address(oneDV2), hex"");

        labelAddresses();
    }

    function labelAddresses() internal {
        vm.label(owner, "owner");
        vm.label(admin, "admin");
        vm.label(proxy, "proxy");
        // vm.label(address(oneDV2), "Composer");
        vm.label(mockSender, "MeMeMeMe");
    }

    function test_fork_raw_bnb_swap() external {
        vm.prank(mockSender);
        address(proxy).call{value: 0}(getData());
    }

    function test_fork_params_bnb() external {
        vm.prank(mockSender);
        (bytes memory params, uint256 value) = getParams2();
        IComposerLike(proxy).deltaCompose{value: value}(params);
    }

    // nonce 0n
    // cometCreditPermit.ts:120 expiry 1748970849
    // cometCreditPermit.ts:121 v,r,s 27n 0x8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f 0x16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab
    // cometCreditPermit.ts:126 r 8c2ebd619f0fef85520e275e95f372e76a6442b28cfe60b76547baca0decc64f
    // cometCreditPermit.ts:127 vs 16eac8a7b9737f99696f09db674e26ce6e362eb4036153e70a5f9da3eece7aab

    function getData() internal pure returns (bytes memory d) {
        d =
            hex"17d73091000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000011b4400555d398326f99059ff775485246999027b31979558f73b65b4caaf64fba2af91cc5d4a2a1318e5d8c600055d398326f99059ff775485246999027b31979558f73b65b4caaf64fba2af91cc5d4a2a1318e5d8c00000000000000001adf939d5eef2e9f111300400155d398326f99059ff775485246999027b3197955fca1150ea45ba50323c27a7d5e823d92d2e59a050100000000000000001adf939d5eef2e9f20fca1150ea45ba50323c27a7d5e823d92d2e59a05000000000000000000000000000000000fd5400555d398326f99059ff775485246999027b3197955126968af1c00a094f7eff5c0aa4b5bda97dc51b620126968af1c00a094f7eff5c0aa4b5bda97dc51b6000000000000000000000000000000000f84e3665a430000000000000000000000000000000000000000000000001adf939d5eef2e9f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000bb800000000000000000000000055d398326f99059ff775485246999027b3197955000000000000000000000000daf87a186345f26d107d000fad351e79ff696d2c00000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000e8435f1040100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000001adf939d5eef2e9f0000000000000000000000000000000000000000000000000005d83617c787760000000000000000000000000000000000000000000000000005e753156f0a1f000000000000000000000000000000000000000000000000000001d1a94a20000000000000000000000000000000000000000000000000000000000000000140000000000000000000000000816ebc5cb8a5651c902cb06659907a93e574db0b0000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000000600000000000000000000000055d398326f99059ff775485246999027b31979550000000000000000000000008263cd1601fe73c066bf49cc09841f35348e3be0000000000000000000000000e9e7cea3dedca5984780bafc599bd69add087d560000000000000000000000000a43fc31a73013089df59194872ecae4cae14444000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000185554555455550000000100000001000000010000000100000000000000000000000000000000000000000000000000000000000000000000000000000000001c00000003000000010000000200010004000200040003000400040005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000002c000000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000078000000000000000000000000000000000000000000000000000000000000009400000000000000000000000000000000000000000000000000000000000000ac000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000184b3ddf04e00000000000000000000000000000000000000000000000008f5283f28e60ba800000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000005655d398326f99059ff775485246999027b319795528e2ea090877bf75740558f6bfb36a5ffee9e9df000bb800003c00000000000000000000000000000000000000000a43fc31a73013089df59194872ecae4cae1444400000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000012453e9d16c00000000000000000000000000000000000000000000000008f5283f28e60ba8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000300000000000000000000000055d398326f99059ff775485246999027b319795500000000000000000000000086407bea2078ea5f5eb5a52b2caa963bc1f889da0000000000000000000000008263cd1601fe73c066bf49cc09841f35348e3be000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001a40dcbae6600000000000000000000000000000000000000000000000008f5431f0d23174f00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001000000000000000000000000023ff63aa03060cfe97018e2854318bea9873fd500000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000200000000000000000000000055d398326f99059ff775485246999027b3197955000000000000000000000000e9e7cea3dedca5984780bafc599bd69add087d5600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e4707ea9bd0000000000000000000000000000000000000000000000022cc5c147b801b696000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003f8263cd1601fe73c066bf49cc09841f35348e3be00bfbcf9fa4f9c56b0f40a671ad40e0805a091865002710bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001640e65086b00000000000000000000000000000000000000000000000008f55d68df091ee000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003000000000000000000000000e9e7cea3dedca5984780bafc599bd69add087d560000000000000000000000000efc2d2d054383462f2cd72ea2526ef7687e1016000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000012453e9d16c00000000000000000000000000000000000000000000000049f6300dbdcab1cd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000030000000000000000000000000a43fc31a73013089df59194872ecae4cae14444000000000000000000000000ca143ce32fe78f1f7019d7d551a6402fc5350c73000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000064d33ee2a40000000000000000000000000000000000000000000000000005e24b7f170a9500000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000f9f000000000000000000000000000000000000000001000000000000000000000000000000bada9c382165b31419f4cc0edf0fa84f80a3c8e5a07c5b74c9b40447a954e1466938b865b6bbea3630030f9f55d398326f99059ff775485246999027b31979550000ffffffffffffffffffffffffffff816ebc5cb8a5651c902cb06659907a93e574db0bfd5840cd36d94d7229439859c0112a4185bc025540010000000000000000000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c0100000000000000001adf939d5eef2e9f400155d398326f99059ff775485246999027b3197955bada9c382165b31419f4cc0edf0fa84f80a3c8e50000000000000000000000000000000000000000000000000000000000";
    }

    function getParams2() internal pure returns (bytes memory d, uint256 value) {
        value = 0;
        d =
            hex"400555d398326f99059ff775485246999027b31979558f73b65b4caaf64fba2af91cc5d4a2a1318e5d8c600055d398326f99059ff775485246999027b31979558f73b65b4caaf64fba2af91cc5d4a2a1318e5d8c00000000000000001adf939d5eef2e9f10d800400155d398326f99059ff775485246999027b3197955fca1150ea45ba50323c27a7d5e823d92d2e59a050100000000000000001adf939d5eef2e9f20fca1150ea45ba50323c27a7d5e823d92d2e59a05000000000000000000000000000000000fd5400555d398326f99059ff775485246999027b3197955126968af1c00a094f7eff5c0aa4b5bda97dc51b620126968af1c00a094f7eff5c0aa4b5bda97dc51b6000000000000000000000000000000000f84e3665a430000000000000000000000000000000000000000000000001adf939d5eef2e9f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000bb800000000000000000000000055d398326f99059ff775485246999027b3197955000000000000000000000000daf87a186345f26d107d000fad351e79ff696d2c00000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000e8435f1040100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000001adf939d5eef2e9f0000000000000000000000000000000000000000000000000005d83617c787760000000000000000000000000000000000000000000000000005e753156f0a1f000000000000000000000000000000000000000000000000000001d1a94a20000000000000000000000000000000000000000000000000000000000000000140000000000000000000000000816ebc5cb8a5651c902cb06659907a93e574db0b0000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000000000002c0000000000000000000000000000000000000000000000000000000000000000600000000000000000000000055d398326f99059ff775485246999027b31979550000000000000000000000008263cd1601fe73c066bf49cc09841f35348e3be0000000000000000000000000e9e7cea3dedca5984780bafc599bd69add087d560000000000000000000000000a43fc31a73013089df59194872ecae4cae14444000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000000000000000000185554555455550000000100000001000000010000000100000000000000000000000000000000000000000000000000000000000000000000000000000000001c00000003000000010000000200010004000200040003000400040005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000700000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000002c000000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000000000000000000000000000000640000000000000000000000000000000000000000000000000000000000000078000000000000000000000000000000000000000000000000000000000000009400000000000000000000000000000000000000000000000000000000000000ac000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000184b3ddf04e00000000000000000000000000000000000000000000000008f5283f28e60ba800000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000005655d398326f99059ff775485246999027b319795528e2ea090877bf75740558f6bfb36a5ffee9e9df000bb800003c00000000000000000000000000000000000000000a43fc31a73013089df59194872ecae4cae1444400000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000012453e9d16c00000000000000000000000000000000000000000000000008f5283f28e60ba8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000300000000000000000000000055d398326f99059ff775485246999027b319795500000000000000000000000086407bea2078ea5f5eb5a52b2caa963bc1f889da0000000000000000000000008263cd1601fe73c066bf49cc09841f35348e3be000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001a40dcbae6600000000000000000000000000000000000000000000000008f5431f0d23174f00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000001000000000000000000000000023ff63aa03060cfe97018e2854318bea9873fd500000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000200000000000000000000000055d398326f99059ff775485246999027b3197955000000000000000000000000e9e7cea3dedca5984780bafc599bd69add087d5600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e4707ea9bd0000000000000000000000000000000000000000000000022cc5c147b801b696000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003f8263cd1601fe73c066bf49cc09841f35348e3be00bfbcf9fa4f9c56b0f40a671ad40e0805a091865002710bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001640e65086b00000000000000000000000000000000000000000000000008f55d68df091ee000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003000000000000000000000000e9e7cea3dedca5984780bafc599bd69add087d560000000000000000000000000efc2d2d054383462f2cd72ea2526ef7687e1016000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000012453e9d16c00000000000000000000000000000000000000000000000049f6300dbdcab1cd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000030000000000000000000000000a43fc31a73013089df59194872ecae4cae14444000000000000000000000000ca143ce32fe78f1f7019d7d551a6402fc5350c73000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000064d33ee2a40000000000000000000000000000000000000000000000000005e24b7f170a9500000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000f9f000000000000000000000000000000000000000001000000000000000000000000000000bada9c382165b31419f4cc0edf0fa84f80a3c8e5a07c5b74c9b40447a954e1466938b865b6bbea3630030f9f55d398326f99059ff775485246999027b31979550000ffffffffffffffffffffffffffff816ebc5cb8a5651c902cb06659907a93e574db0bfd5840cd36d94d7229439859c0112a4185bc0255400155d398326f99059ff775485246999027b3197955bada9c382165b31419f4cc0edf0fa84f80a3c8e50000000000000000000000000000000000";
    }
}

// 0xb2f481d177fb61a2c8b8b27503d3f33b5596c6b7f1dd2246e8d14a6e49487bc2000000000000000000000000000000000000000000000000000000000000001c4e
// 0xb2f481d177fb61a2c8b8b27503d3f33b5596c6b7f1dd2246e8d14a6e49487bc2bfa8d508ba63b8f460adba12ced111eda5b0a53c9cabb6b052f3e5297586154e
// 0xb2f481d177fb61a2c8b8b27503d3f33b5596c6b7f1dd2246e8d14a6e49487bc23fa8d508ba63b8f460adba12ced111eda5b0a53c9cabb6b052f3e5297586154e1c
